<?php
/*
*
*  Sky Fortress V1.0 by Cher Ami
*
*  Credits:
*    Me, for writing the code (obviously)
*    The good people who developed PHP
*    The phpSecLib dev team ( http://phpseclib.sourceforge.net/ )
*
*  Legal:
*    I don't care what you do with this file. If you have the source, all of the
*    work I've put in this may as well be yours. You can take my name off of it,
*    change the name of the software, you can do *ANYTHING* you want with it.
*    'Mi casa es su casa' as the Spanish would say. All I ask is that, if you do
*    use this source elsewhere, that you not use it for malicious purposes and
*    that you not try to view what users upload without their knowledge.
*
*  Live demo:
*    http://shxdhomhggy3bjrn.onion/skyfortress/
*
*  Installation:
*    1.) Drop this file wherever you want with whatever name you want.
*    2.) Chmod this file to 777.
*    3.) Create a folder named "crypt" in the same directory.
*    4.) Chmod that folder to 777.
*    5.) Spread the link around. :)
*
*/

// This is a base64-encoded AES encryption/decryption library taken from phpSecLib.
// If you don't trust it, base64_decode it yourself and take a look. c:
eval(base64_decode("ZGVmaW5lKCdDUllQVF9SSUpOREFFTF9NT0RFX0NUUicsIC0xKTsNCmRlZmluZSgnQ1JZUFRfUklKTkRBRUxfTU9ERV9FQ0InLCAxKTsNCmRlZmluZSgnQ1JZUFRfUklKTkRBRUxfTU9ERV9DQkMnLCAyKTsNCmRlZmluZSgnQ1JZUFRfUklKTkRBRUxfTU9ERV9DRkInLCAzKTsNCmRlZmluZSgnQ1JZUFRfUklKTkRBRUxfTU9ERV9PRkInLCA0KTsNCmRlZmluZSgnQ1JZUFRfUklKTkRBRUxfTU9ERV9JTlRFUk5BTCcsIDEpOw0KDQpkZWZpbmUoJ0NSWVBUX1JJSk5EQUVMX01PREVfTUNSWVBUJywgMik7DQoNCmNsYXNzIENyeXB0X1Jpam5kYWVsIHsNCnZhciAkbW9kZTsNCg0KdmFyICRrZXkgPSAiXDBcMFwwXDBcMFwwXDBcMFwwXDBcMFwwXDBcMFwwXDAiOw0KDQp2YXIgJGl2ID0gJyc7DQoNCnZhciAkZW5jcnlwdElWID0gJyc7DQoNCnZhciAkZGVjcnlwdElWID0gJyc7DQoNCnZhciAkY29udGludW91c0J1ZmZlciA9IGZhbHNlOw0KDQp2YXIgJHBhZGRpbmcgPSB0cnVlOw0KDQp2YXIgJGNoYW5nZWQgPSB0cnVlOw0KDQp2YXIgJGV4cGxpY2l0X2tleV9sZW5ndGggPSBmYWxzZTsNCg0KdmFyICR3Ow0KDQp2YXIgJGR3Ow0KDQp2YXIgJGJsb2NrX3NpemUgPSAxNjsNCg0KdmFyICROYiA9IDQ7DQoNCnZhciAka2V5X3NpemUgPSAxNjsNCg0KdmFyICROayA9IDQ7DQoNCnZhciAkTnI7DQoNCnZhciAkYzsNCg0KdmFyICR0MDsNCg0KdmFyICR0MTsNCnZhciAkdDI7DQp2YXIgJHQzOw0KdmFyICRkdDA7DQp2YXIgJGR0MTsNCnZhciAkZHQyOw0KdmFyICRkdDM7DQp2YXIgJHBhZGRhYmxlID0gZmFsc2U7DQp2YXIgJGVuYnVmZmVyID0gYXJyYXkoJ2VuY3J5cHRlZCcgPT4gJycsICd4b3InID0+ICcnKTsNCnZhciAkZGVidWZmZXIgPSBhcnJheSgnY2lwaGVydGV4dCcgPT4gJycpOw0KZnVuY3Rpb24gQ3J5cHRfUmlqbmRhZWwoJG1vZGUgPSBDUllQVF9SSUpOREFFTF9NT0RFX0NCQykNCnsNCnN3aXRjaCAoJG1vZGUpIHsNCmNhc2UgQ1JZUFRfUklKTkRBRUxfTU9ERV9FQ0I6DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfQ0JDOg0KJHRoaXMtPnBhZGRhYmxlID0gdHJ1ZTsNCiR0aGlzLT5tb2RlID0gJG1vZGU7DQpicmVhazsNCmNhc2UgQ1JZUFRfUklKTkRBRUxfTU9ERV9DVFI6DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfQ0ZCOg0KY2FzZSBDUllQVF9SSUpOREFFTF9NT0RFX09GQjoNCiR0aGlzLT5tb2RlID0gJG1vZGU7DQpicmVhazsNCmRlZmF1bHQ6DQokdGhpcy0+cGFkZGFibGUgPSB0cnVlOw0KJHRoaXMtPm1vZGUgPSBDUllQVF9SSUpOREFFTF9NT0RFX0NCQzsNCn0NCg0KJHQzID0gJiR0aGlzLT50MzsNCiR0MiA9ICYkdGhpcy0+dDI7DQokdDEgPSAmJHRoaXMtPnQxOw0KJHQwID0gJiR0aGlzLT50MDsNCg0KJGR0MyA9ICYkdGhpcy0+ZHQzOw0KJGR0MiA9ICYkdGhpcy0+ZHQyOw0KJGR0MSA9ICYkdGhpcy0+ZHQxOw0KJGR0MCA9ICYkdGhpcy0+ZHQwOw0KJHQzID0gYXJyYXkoDQoweDYzNjNBNUM2LCAweDdDN0M4NEY4LCAweDc3Nzc5OUVFLCAweDdCN0I4REY2LCAweEYyRjIwREZGLCAweDZCNkJCREQ2LCAweDZGNkZCMURFLCAweEM1QzU1NDkxLCANCjB4MzAzMDUwNjAsIDB4MDEwMTAzMDIsIDB4Njc2N0E5Q0UsIDB4MkIyQjdENTYsIDB4RkVGRTE5RTcsIDB4RDdENzYyQjUsIDB4QUJBQkU2NEQsIDB4NzY3NjlBRUMsIA0KMHhDQUNBNDU4RiwgMHg4MjgyOUQxRiwgMHhDOUM5NDA4OSwgMHg3RDdEODdGQSwgMHhGQUZBMTVFRiwgMHg1OTU5RUJCMiwgMHg0NzQ3Qzk4RSwgMHhGMEYwMEJGQiwgDQoweEFEQURFQzQxLCAweEQ0RDQ2N0IzLCAweEEyQTJGRDVGLCAweEFGQUZFQTQ1LCAweDlDOUNCRjIzLCAweEE0QTRGNzUzLCAweDcyNzI5NkU0LCAweEMwQzA1QjlCLCANCjB4QjdCN0MyNzUsIDB4RkRGRDFDRTEsIDB4OTM5M0FFM0QsIDB4MjYyNjZBNEMsIDB4MzYzNjVBNkMsIDB4M0YzRjQxN0UsIDB4RjdGNzAyRjUsIDB4Q0NDQzRGODMsIA0KMHgzNDM0NUM2OCwgMHhBNUE1RjQ1MSwgMHhFNUU1MzREMSwgMHhGMUYxMDhGOSwgMHg3MTcxOTNFMiwgMHhEOEQ4NzNBQiwgMHgzMTMxNTM2MiwgMHgxNTE1M0YyQSwgDQoweDA0MDQwQzA4LCAweEM3Qzc1Mjk1LCAweDIzMjM2NTQ2LCAweEMzQzM1RTlELCAweDE4MTgyODMwLCAweDk2OTZBMTM3LCAweDA1MDUwRjBBLCAweDlBOUFCNTJGLCANCjB4MDcwNzA5MEUsIDB4MTIxMjM2MjQsIDB4ODA4MDlCMUIsIDB4RTJFMjNEREYsIDB4RUJFQjI2Q0QsIDB4MjcyNzY5NEUsIDB4QjJCMkNEN0YsIDB4NzU3NTlGRUEsIA0KMHgwOTA5MUIxMiwgMHg4MzgzOUUxRCwgMHgyQzJDNzQ1OCwgMHgxQTFBMkUzNCwgMHgxQjFCMkQzNiwgMHg2RTZFQjJEQywgMHg1QTVBRUVCNCwgMHhBMEEwRkI1QiwgDQoweDUyNTJGNkE0LCAweDNCM0I0RDc2LCAweEQ2RDY2MUI3LCAweEIzQjNDRTdELCAweDI5Mjk3QjUyLCAweEUzRTMzRURELCAweDJGMkY3MTVFLCAweDg0ODQ5NzEzLCANCjB4NTM1M0Y1QTYsIDB4RDFEMTY4QjksIDB4MDAwMDAwMDAsIDB4RURFRDJDQzEsIDB4MjAyMDYwNDAsIDB4RkNGQzFGRTMsIDB4QjFCMUM4NzksIDB4NUI1QkVEQjYsIA0KMHg2QTZBQkVENCwgMHhDQkNCNDY4RCwgMHhCRUJFRDk2NywgMHgzOTM5NEI3MiwgMHg0QTRBREU5NCwgMHg0QzRDRDQ5OCwgMHg1ODU4RThCMCwgMHhDRkNGNEE4NSwgDQoweEQwRDA2QkJCLCAweEVGRUYyQUM1LCAweEFBQUFFNTRGLCAweEZCRkIxNkVELCAweDQzNDNDNTg2LCAweDRENERENzlBLCAweDMzMzM1NTY2LCAweDg1ODU5NDExLCANCjB4NDU0NUNGOEEsIDB4RjlGOTEwRTksIDB4MDIwMjA2MDQsIDB4N0Y3RjgxRkUsIDB4NTA1MEYwQTAsIDB4M0MzQzQ0NzgsIDB4OUY5RkJBMjUsIDB4QThBOEUzNEIsIA0KMHg1MTUxRjNBMiwgMHhBM0EzRkU1RCwgMHg0MDQwQzA4MCwgMHg4RjhGOEEwNSwgMHg5MjkyQUQzRiwgMHg5RDlEQkMyMSwgMHgzODM4NDg3MCwgMHhGNUY1MDRGMSwgDQoweEJDQkNERjYzLCAweEI2QjZDMTc3LCAweERBREE3NUFGLCAweDIxMjE2MzQyLCAweDEwMTAzMDIwLCAweEZGRkYxQUU1LCAweEYzRjMwRUZELCAweEQyRDI2REJGLCANCjB4Q0RDRDRDODEsIDB4MEMwQzE0MTgsIDB4MTMxMzM1MjYsIDB4RUNFQzJGQzMsIDB4NUY1RkUxQkUsIDB4OTc5N0EyMzUsIDB4NDQ0NENDODgsIDB4MTcxNzM5MkUsIA0KMHhDNEM0NTc5MywgMHhBN0E3RjI1NSwgMHg3RTdFODJGQywgMHgzRDNENDc3QSwgMHg2NDY0QUNDOCwgMHg1RDVERTdCQSwgMHgxOTE5MkIzMiwgMHg3MzczOTVFNiwgDQoweDYwNjBBMEMwLCAweDgxODE5ODE5LCAweDRGNEZEMTlFLCAweERDREM3RkEzLCAweDIyMjI2NjQ0LCAweDJBMkE3RTU0LCAweDkwOTBBQjNCLCAweDg4ODg4MzBCLCANCjB4NDY0NkNBOEMsIDB4RUVFRTI5QzcsIDB4QjhCOEQzNkIsIDB4MTQxNDNDMjgsIDB4REVERTc5QTcsIDB4NUU1RUUyQkMsIDB4MEIwQjFEMTYsIDB4REJEQjc2QUQsIA0KMHhFMEUwM0JEQiwgMHgzMjMyNTY2NCwgMHgzQTNBNEU3NCwgMHgwQTBBMUUxNCwgMHg0OTQ5REI5MiwgMHgwNjA2MEEwQywgMHgyNDI0NkM0OCwgMHg1QzVDRTRCOCwgDQoweEMyQzI1RDlGLCAweEQzRDM2RUJELCAweEFDQUNFRjQzLCAweDYyNjJBNkM0LCAweDkxOTFBODM5LCAweDk1OTVBNDMxLCAweEU0RTQzN0QzLCAweDc5Nzk4QkYyLCANCjB4RTdFNzMyRDUsIDB4QzhDODQzOEIsIDB4MzczNzU5NkUsIDB4NkQ2REI3REEsIDB4OEQ4RDhDMDEsIDB4RDVENTY0QjEsIDB4NEU0RUQyOUMsIDB4QTlBOUUwNDksIA0KMHg2QzZDQjREOCwgMHg1NjU2RkFBQywgMHhGNEY0MDdGMywgMHhFQUVBMjVDRiwgMHg2NTY1QUZDQSwgMHg3QTdBOEVGNCwgMHhBRUFFRTk0NywgMHgwODA4MTgxMCwgDQoweEJBQkFENTZGLCAweDc4Nzg4OEYwLCAweDI1MjU2RjRBLCAweDJFMkU3MjVDLCAweDFDMUMyNDM4LCAweEE2QTZGMTU3LCAweEI0QjRDNzczLCAweEM2QzY1MTk3LCANCjB4RThFODIzQ0IsIDB4RERERDdDQTEsIDB4NzQ3NDlDRTgsIDB4MUYxRjIxM0UsIDB4NEI0QkREOTYsIDB4QkRCRERDNjEsIDB4OEI4Qjg2MEQsIDB4OEE4QTg1MEYsIA0KMHg3MDcwOTBFMCwgMHgzRTNFNDI3QywgMHhCNUI1QzQ3MSwgMHg2NjY2QUFDQywgMHg0ODQ4RDg5MCwgMHgwMzAzMDUwNiwgMHhGNkY2MDFGNywgMHgwRTBFMTIxQywgDQoweDYxNjFBM0MyLCAweDM1MzU1RjZBLCAweDU3NTdGOUFFLCAweEI5QjlEMDY5LCAweDg2ODY5MTE3LCAweEMxQzE1ODk5LCAweDFEMUQyNzNBLCAweDlFOUVCOTI3LCANCjB4RTFFMTM4RDksIDB4RjhGODEzRUIsIDB4OTg5OEIzMkIsIDB4MTExMTMzMjIsIDB4Njk2OUJCRDIsIDB4RDlEOTcwQTksIDB4OEU4RTg5MDcsIDB4OTQ5NEE3MzMsIA0KMHg5QjlCQjYyRCwgMHgxRTFFMjIzQywgMHg4Nzg3OTIxNSwgMHhFOUU5MjBDOSwgMHhDRUNFNDk4NywgMHg1NTU1RkZBQSwgMHgyODI4Nzg1MCwgMHhERkRGN0FBNSwgDQoweDhDOEM4RjAzLCAweEExQTFGODU5LCAweDg5ODk4MDA5LCAweDBEMEQxNzFBLCAweEJGQkZEQTY1LCAweEU2RTYzMUQ3LCAweDQyNDJDNjg0LCAweDY4NjhCOEQwLCANCjB4NDE0MUMzODIsIDB4OTk5OUIwMjksIDB4MkQyRDc3NUEsIDB4MEYwRjExMUUsIDB4QjBCMENCN0IsIDB4NTQ1NEZDQTgsIDB4QkJCQkQ2NkQsIDB4MTYxNjNBMkMNCik7DQoNCiRkdDMgPSBhcnJheSgNCjB4RjRBNzUwNTEsIDB4NDE2NTUzN0UsIDB4MTdBNEMzMUEsIDB4Mjc1RTk2M0EsIDB4QUI2QkNCM0IsIDB4OUQ0NUYxMUYsIDB4RkE1OEFCQUMsIDB4RTMwMzkzNEIsIA0KMHgzMEZBNTUyMCwgMHg3NjZERjZBRCwgMHhDQzc2OTE4OCwgMHgwMjRDMjVGNSwgMHhFNUQ3RkM0RiwgMHgyQUNCRDdDNSwgMHgzNTQ0ODAyNiwgMHg2MkEzOEZCNSwgDQoweEIxNUE0OURFLCAweEJBMUI2NzI1LCAweEVBMEU5ODQ1LCAweEZFQzBFMTVELCAweDJGNzUwMkMzLCAweDRDRjAxMjgxLCAweDQ2OTdBMzhELCAweEQzRjlDNjZCLCANCjB4OEY1RkU3MDMsIDB4OTI5Qzk1MTUsIDB4NkQ3QUVCQkYsIDB4NTI1OURBOTUsIDB4QkU4MzJERDQsIDB4NzQyMUQzNTgsIDB4RTA2OTI5NDksIDB4QzlDODQ0OEUsIA0KMHhDMjg5NkE3NSwgMHg4RTc5NzhGNCwgMHg1ODNFNkI5OSwgMHhCOTcxREQyNywgMHhFMTRGQjZCRSwgMHg4OEFEMTdGMCwgMHgyMEFDNjZDOSwgMHhDRTNBQjQ3RCwgDQoweERGNEExODYzLCAweDFBMzE4MkU1LCAweDUxMzM2MDk3LCAweDUzN0Y0NTYyLCAweDY0NzdFMEIxLCAweDZCQUU4NEJCLCAweDgxQTAxQ0ZFLCAweDA4MkI5NEY5LCANCjB4NDg2ODU4NzAsIDB4NDVGRDE5OEYsIDB4REU2Qzg3OTQsIDB4N0JGOEI3NTIsIDB4NzNEMzIzQUIsIDB4NEIwMkUyNzIsIDB4MUY4RjU3RTMsIDB4NTVBQjJBNjYsIA0KMHhFQjI4MDdCMiwgMHhCNUMyMDMyRiwgMHhDNTdCOUE4NiwgMHgzNzA4QTVEMywgMHgyODg3RjIzMCwgMHhCRkE1QjIyMywgMHgwMzZBQkEwMiwgMHgxNjgyNUNFRCwgDQoweENGMUMyQjhBLCAweDc5QjQ5MkE3LCAweDA3RjJGMEYzLCAweDY5RTJBMTRFLCAweERBRjRDRDY1LCAweDA1QkVENTA2LCAweDM0NjIxRkQxLCAweEE2RkU4QUM0LCANCjB4MkU1MzlEMzQsIDB4RjM1NUEwQTIsIDB4OEFFMTMyMDUsIDB4RjZFQjc1QTQsIDB4ODNFQzM5MEIsIDB4NjBFRkFBNDAsIDB4NzE5RjA2NUUsIDB4NkUxMDUxQkQsIA0KMHgyMThBRjkzRSwgMHhERDA2M0Q5NiwgMHgzRTA1QUVERCwgMHhFNkJENDY0RCwgMHg1NDhEQjU5MSwgMHhDNDVEMDU3MSwgMHgwNkQ0NkYwNCwgMHg1MDE1RkY2MCwgDQoweDk4RkIyNDE5LCAweEJERTk5N0Q2LCAweDQwNDNDQzg5LCAweEQ5OUU3NzY3LCAweEU4NDJCREIwLCAweDg5OEI4ODA3LCAweDE5NUIzOEU3LCAweEM4RUVEQjc5LCANCjB4N0MwQTQ3QTEsIDB4NDIwRkU5N0MsIDB4ODQxRUM5RjgsIDB4MDAwMDAwMDAsIDB4ODA4NjgzMDksIDB4MkJFRDQ4MzIsIDB4MTE3MEFDMUUsIDB4NUE3MjRFNkMsIA0KMHgwRUZGRkJGRCwgMHg4NTM4NTYwRiwgMHhBRUQ1MUUzRCwgMHgyRDM5MjczNiwgMHgwRkQ5NjQwQSwgMHg1Q0E2MjE2OCwgMHg1QjU0RDE5QiwgMHgzNjJFM0EyNCwgDQoweDBBNjdCMTBDLCAweDU3RTcwRjkzLCAweEVFOTZEMkI0LCAweDlCOTE5RTFCLCAweEMwQzU0RjgwLCAweERDMjBBMjYxLCAweDc3NEI2OTVBLCAweDEyMUExNjFDLCANCjB4OTNCQTBBRTIsIDB4QTAyQUU1QzAsIDB4MjJFMDQzM0MsIDB4MUIxNzFEMTIsIDB4MDkwRDBCMEUsIDB4OEJDN0FERjIsIDB4QjZBOEI5MkQsIDB4MUVBOUM4MTQsIA0KMHhGMTE5ODU1NywgMHg3NTA3NENBRiwgMHg5OUREQkJFRSwgMHg3RjYwRkRBMywgMHgwMTI2OUZGNywgMHg3MkY1QkM1QywgMHg2NjNCQzU0NCwgMHhGQjdFMzQ1QiwgDQoweDQzMjk3NjhCLCAweDIzQzZEQ0NCLCAweEVERkM2OEI2LCAweEU0RjE2M0I4LCAweDMxRENDQUQ3LCAweDYzODUxMDQyLCAweDk3MjI0MDEzLCAweEM2MTEyMDg0LCANCjB4NEEyNDdEODUsIDB4QkIzREY4RDIsIDB4RjkzMjExQUUsIDB4MjlBMTZEQzcsIDB4OUUyRjRCMUQsIDB4QjIzMEYzREMsIDB4ODY1MkVDMEQsIDB4QzFFM0QwNzcsIA0KMHhCMzE2NkMyQiwgMHg3MEI5OTlBOSwgMHg5NDQ4RkExMSwgMHhFOTY0MjI0NywgMHhGQzhDQzRBOCwgMHhGMDNGMUFBMCwgMHg3RDJDRDg1NiwgMHgzMzkwRUYyMiwgDQoweDQ5NEVDNzg3LCAweDM4RDFDMUQ5LCAweENBQTJGRThDLCAweEQ0MEIzNjk4LCAweEY1ODFDRkE2LCAweDdBREUyOEE1LCAweEI3OEUyNkRBLCAweEFEQkZBNDNGLCANCjB4M0E5REU0MkMsIDB4Nzg5MjBENTAsIDB4NUZDQzlCNkEsIDB4N0U0NjYyNTQsIDB4OEQxM0MyRjYsIDB4RDhCOEU4OTAsIDB4MzlGNzVFMkUsIDB4QzNBRkY1ODIsIA0KMHg1RDgwQkU5RiwgMHhEMDkzN0M2OSwgMHhENTJEQTk2RiwgMHgyNTEyQjNDRiwgMHhBQzk5M0JDOCwgMHgxODdEQTcxMCwgMHg5QzYzNkVFOCwgMHgzQkJCN0JEQiwgDQoweDI2NzgwOUNELCAweDU5MThGNDZFLCAweDlBQjcwMUVDLCAweDRGOUFBODgzLCAweDk1NkU2NUU2LCAweEZGRTY3RUFBLCAweEJDQ0YwODIxLCAweDE1RThFNkVGLCANCjB4RTc5QkQ5QkEsIDB4NkYzNkNFNEEsIDB4OUYwOUQ0RUEsIDB4QjA3Q0Q2MjksIDB4QTRCMkFGMzEsIDB4M0YyMzMxMkEsIDB4QTU5NDMwQzYsIDB4QTI2NkMwMzUsIA0KMHg0RUJDMzc3NCwgMHg4MkNBQTZGQywgMHg5MEQwQjBFMCwgMHhBN0Q4MTUzMywgMHgwNDk4NEFGMSwgMHhFQ0RBRjc0MSwgMHhDRDUwMEU3RiwgMHg5MUY2MkYxNywgDQoweDRERDY4RDc2LCAweEVGQjA0RDQzLCAweEFBNEQ1NENDLCAweDk2MDRERkU0LCAweEQxQjVFMzlFLCAweDZBODgxQjRDLCAweDJDMUZCOEMxLCAweDY1NTE3RjQ2LCANCjB4NUVFQTA0OUQsIDB4OEMzNTVEMDEsIDB4ODc3NDczRkEsIDB4MEI0MTJFRkIsIDB4NjcxRDVBQjMsIDB4REJEMjUyOTIsIDB4MTA1NjMzRTksIDB4RDY0NzEzNkQsIA0KMHhENzYxOEM5QSwgMHhBMTBDN0EzNywgMHhGODE0OEU1OSwgMHgxMzNDODlFQiwgMHhBOTI3RUVDRSwgMHg2MUM5MzVCNywgMHgxQ0U1RURFMSwgMHg0N0IxM0M3QSwgDQoweEQyREY1OTlDLCAweEYyNzMzRjU1LCAweDE0Q0U3OTE4LCAweEM3MzdCRjczLCAweEY3Q0RFQTUzLCAweEZEQUE1QjVGLCAweDNENkYxNERGLCAweDQ0REI4Njc4LCANCjB4QUZGMzgxQ0EsIDB4NjhDNDNFQjksIDB4MjQzNDJDMzgsIDB4QTM0MDVGQzIsIDB4MURDMzcyMTYsIDB4RTIyNTBDQkMsIDB4M0M0OThCMjgsIDB4MEQ5NTQxRkYsIA0KMHhBODAxNzEzOSwgMHgwQ0IzREUwOCwgMHhCNEU0OUNEOCwgMHg1NkMxOTA2NCwgMHhDQjg0NjE3QiwgMHgzMkI2NzBENSwgMHg2QzVDNzQ0OCwgMHhCODU3NDJEMA0KKTsNCg0KZm9yICgkaSA9IDA7ICRpIDwgMjU2OyAkaSsrKSB7DQokdDJbJGkgPDwgIDhdID0gKCgkdDNbJGldIDw8ICA4KSAmIDB4RkZGRkZGMDApIHwgKCgkdDNbJGldID4+IDI0KSAmIDB4MDAwMDAwRkYpOw0KJHQxWyRpIDw8IDE2XSA9ICgoJHQzWyRpXSA8PCAxNikgJiAweEZGRkYwMDAwKSB8ICgoJHQzWyRpXSA+PiAxNikgJiAweDAwMDBGRkZGKTsNCiR0MFskaSA8PCAyNF0gPSAoKCR0M1skaV0gPDwgMjQpICYgMHhGRjAwMDAwMCkgfCAoKCR0M1skaV0gPj4gIDgpICYgMHgwMEZGRkZGRik7DQoNCiRkdDJbJGkgPDwgIDhdID0gKCgkdGhpcy0+ZHQzWyRpXSA8PCAgOCkgJiAweEZGRkZGRjAwKSB8ICgoJGR0M1skaV0gPj4gMjQpICYgMHgwMDAwMDBGRik7DQokZHQxWyRpIDw8IDE2XSA9ICgoJHRoaXMtPmR0M1skaV0gPDwgMTYpICYgMHhGRkZGMDAwMCkgfCAoKCRkdDNbJGldID4+IDE2KSAmIDB4MDAwMEZGRkYpOw0KJGR0MFskaSA8PCAyNF0gPSAoKCR0aGlzLT5kdDNbJGldIDw8IDI0KSAmIDB4RkYwMDAwMDApIHwgKCgkZHQzWyRpXSA+PiAgOCkgJiAweDAwRkZGRkZGKTsNCn0NCn0NCmZ1bmN0aW9uIHNldEtleSgka2V5KQ0Kew0KJHRoaXMtPmtleSA9ICRrZXk7DQokdGhpcy0+Y2hhbmdlZCA9IHRydWU7DQp9DQpmdW5jdGlvbiBzZXRJVigkaXYpDQp7DQokdGhpcy0+ZW5jcnlwdElWID0gJHRoaXMtPmRlY3J5cHRJViA9ICR0aGlzLT5pdiA9IHN0cl9wYWQoc3Vic3RyKCRpdiwgMCwgJHRoaXMtPmJsb2NrX3NpemUpLCAkdGhpcy0+YmxvY2tfc2l6ZSwgY2hyKDApKTsNCn0NCmZ1bmN0aW9uIHNldEtleUxlbmd0aCgkbGVuZ3RoKQ0Kew0KJGxlbmd0aCA+Pj0gNTsNCmlmICgkbGVuZ3RoID4gOCkgew0KJGxlbmd0aCA9IDg7DQp9IGVsc2UgaWYgKCRsZW5ndGggPCA0KSB7DQokbGVuZ3RoID0gNDsNCn0NCiR0aGlzLT5OayA9ICRsZW5ndGg7DQokdGhpcy0+a2V5X3NpemUgPSAkbGVuZ3RoIDw8IDI7DQoNCiR0aGlzLT5leHBsaWNpdF9rZXlfbGVuZ3RoID0gdHJ1ZTsNCiR0aGlzLT5jaGFuZ2VkID0gdHJ1ZTsNCn0NCmZ1bmN0aW9uIHNldFBhc3N3b3JkKCRwYXNzd29yZCwgJG1ldGhvZCA9ICdwYmtkZjInKQ0Kew0KJGtleSA9ICcnOw0KDQpzd2l0Y2ggKCRtZXRob2QpIHsNCmRlZmF1bHQ6IC8vICdwYmtkZjInDQpsaXN0KCwgLCAkaGFzaCwgJHNhbHQsICRjb3VudCkgPSBmdW5jX2dldF9hcmdzKCk7DQppZiAoIWlzc2V0KCRoYXNoKSkgew0KJGhhc2ggPSAnc2hhMSc7DQp9DQovLyBXUEEgYW5kIFdQQSB1c2UgdGhlIFNTSUQgYXMgdGhlIHNhbHQNCmlmICghaXNzZXQoJHNhbHQpKSB7DQokc2FsdCA9ICdwaHBzZWNsaWIvc2FsdCc7DQp9DQovLyBSRkMyODk4I3NlY3Rpb24tNC4yIHVzZXMgMSwwMDAgaXRlcmF0aW9ucyBieSBkZWZhdWx0DQovLyBXUEEgYW5kIFdQQTIgdXNlIDQsMDk2Lg0KaWYgKCFpc3NldCgkY291bnQpKSB7DQokY291bnQgPSAxMDAwOw0KfQ0KDQppZiAoIWNsYXNzX2V4aXN0cygnQ3J5cHRfSGFzaCcpKSB7DQpyZXF1aXJlX29uY2UoJ0NyeXB0L0hhc2gucGhwJyk7DQp9DQoNCiRpID0gMTsNCndoaWxlIChzdHJsZW4oJGtleSkgPCAkdGhpcy0+a2V5X3NpemUpIHsgLy8gJGRrTGVuID09ICR0aGlzLT5rZXlfc2l6ZQ0KLy8kZGsuPSAkdGhpcy0+X3Bia2RmKCRwYXNzd29yZCwgJHNhbHQsICRjb3VudCwgJGkrKyk7DQokaG1hYyA9IG5ldyBDcnlwdF9IYXNoKCk7DQokaG1hYy0+c2V0SGFzaCgkaGFzaCk7DQokaG1hYy0+c2V0S2V5KCRwYXNzd29yZCk7DQokZiA9ICR1ID0gJGhtYWMtPmhhc2goJHNhbHQgLiBwYWNrKCdOJywgJGkrKykpOw0KZm9yICgkaiA9IDI7ICRqIDw9ICRjb3VudDsgJGorKykgew0KJHUgPSAkaG1hYy0+aGFzaCgkdSk7DQokZl49ICR1Ow0KfQ0KJGtleS49ICRmOw0KfQ0KfQ0KDQokdGhpcy0+c2V0S2V5KHN1YnN0cigka2V5LCAwLCAkdGhpcy0+a2V5X3NpemUpKTsNCn0NCmZ1bmN0aW9uIHNldEJsb2NrTGVuZ3RoKCRsZW5ndGgpDQp7DQokbGVuZ3RoID4+PSA1Ow0KaWYgKCRsZW5ndGggPiA4KSB7DQokbGVuZ3RoID0gODsNCn0gZWxzZSBpZiAoJGxlbmd0aCA8IDQpIHsNCiRsZW5ndGggPSA0Ow0KfQ0KJHRoaXMtPk5iID0gJGxlbmd0aDsNCiR0aGlzLT5ibG9ja19zaXplID0gJGxlbmd0aCA8PCAyOw0KJHRoaXMtPmNoYW5nZWQgPSB0cnVlOw0KfQ0KZnVuY3Rpb24gX2dlbmVyYXRlX3hvcigkbGVuZ3RoLCAmJGl2KQ0Kew0KJHhvciA9ICcnOw0KJGJsb2NrX3NpemUgPSAkdGhpcy0+YmxvY2tfc2l6ZTsNCiRudW1fYmxvY2tzID0gZmxvb3IoKCRsZW5ndGggKyAoJGJsb2NrX3NpemUgLSAxKSkgLyAkYmxvY2tfc2l6ZSk7DQpmb3IgKCRpID0gMDsgJGkgPCAkbnVtX2Jsb2NrczsgJGkrKykgew0KJHhvci49ICRpdjsNCmZvciAoJGogPSA0OyAkaiA8PSAkYmxvY2tfc2l6ZTsgJGorPTQpIHsNCiR0ZW1wID0gc3Vic3RyKCRpdiwgLSRqLCA0KTsNCnN3aXRjaCAoJHRlbXApIHsNCmNhc2UgIlx4RkZceEZGXHhGRlx4RkYiOg0KJGl2ID0gc3Vic3RyX3JlcGxhY2UoJGl2LCAiXHgwMFx4MDBceDAwXHgwMCIsIC0kaiwgNCk7DQpicmVhazsNCmNhc2UgIlx4N0ZceEZGXHhGRlx4RkYiOg0KJGl2ID0gc3Vic3RyX3JlcGxhY2UoJGl2LCAiXHg4MFx4MDBceDAwXHgwMCIsIC0kaiwgNCk7DQpicmVhayAyOw0KZGVmYXVsdDoNCmV4dHJhY3QodW5wYWNrKCdOY291bnQnLCAkdGVtcCkpOw0KJGl2ID0gc3Vic3RyX3JlcGxhY2UoJGl2LCBwYWNrKCdOJywgJGNvdW50ICsgMSksIC0kaiwgNCk7DQpicmVhayAyOw0KfQ0KfQ0KfQ0KDQpyZXR1cm4gJHhvcjsNCn0NCmZ1bmN0aW9uIGVuY3J5cHQoJHBsYWludGV4dCkNCnsNCiR0aGlzLT5fc2V0dXAoKTsNCmlmICgkdGhpcy0+cGFkZGFibGUpIHsNCiRwbGFpbnRleHQgPSAkdGhpcy0+X3BhZCgkcGxhaW50ZXh0KTsNCn0NCg0KJGJsb2NrX3NpemUgPSAkdGhpcy0+YmxvY2tfc2l6ZTsNCiRidWZmZXIgPSAmJHRoaXMtPmVuYnVmZmVyOw0KJGNvbnRpbnVvdXNCdWZmZXIgPSAkdGhpcy0+Y29udGludW91c0J1ZmZlcjsNCiRjaXBoZXJ0ZXh0ID0gJyc7DQpzd2l0Y2ggKCR0aGlzLT5tb2RlKSB7DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfRUNCOg0KZm9yICgkaSA9IDA7ICRpIDwgc3RybGVuKCRwbGFpbnRleHQpOyAkaSs9JGJsb2NrX3NpemUpIHsNCiRjaXBoZXJ0ZXh0Lj0gJHRoaXMtPl9lbmNyeXB0QmxvY2soc3Vic3RyKCRwbGFpbnRleHQsICRpLCAkYmxvY2tfc2l6ZSkpOw0KfQ0KYnJlYWs7DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfQ0JDOg0KJHhvciA9ICR0aGlzLT5lbmNyeXB0SVY7DQpmb3IgKCRpID0gMDsgJGkgPCBzdHJsZW4oJHBsYWludGV4dCk7ICRpKz0kYmxvY2tfc2l6ZSkgew0KJGJsb2NrID0gc3Vic3RyKCRwbGFpbnRleHQsICRpLCAkYmxvY2tfc2l6ZSk7DQokYmxvY2sgPSAkdGhpcy0+X2VuY3J5cHRCbG9jaygkYmxvY2sgXiAkeG9yKTsNCiR4b3IgPSAkYmxvY2s7DQokY2lwaGVydGV4dC49ICRibG9jazsNCn0NCmlmICgkdGhpcy0+Y29udGludW91c0J1ZmZlcikgew0KJHRoaXMtPmVuY3J5cHRJViA9ICR4b3I7DQp9DQpicmVhazsNCmNhc2UgQ1JZUFRfUklKTkRBRUxfTU9ERV9DVFI6DQokeG9yID0gJHRoaXMtPmVuY3J5cHRJVjsNCmlmICghZW1wdHkoJGJ1ZmZlclsnZW5jcnlwdGVkJ10pKSB7DQpmb3IgKCRpID0gMDsgJGkgPCBzdHJsZW4oJHBsYWludGV4dCk7ICRpKz0kYmxvY2tfc2l6ZSkgew0KJGJsb2NrID0gc3Vic3RyKCRwbGFpbnRleHQsICRpLCAkYmxvY2tfc2l6ZSk7DQokYnVmZmVyWydlbmNyeXB0ZWQnXS49ICR0aGlzLT5fZW5jcnlwdEJsb2NrKCR0aGlzLT5fZ2VuZXJhdGVfeG9yKCRibG9ja19zaXplLCAkeG9yKSk7DQoka2V5ID0gJHRoaXMtPl9zdHJpbmdfc2hpZnQoJGJ1ZmZlclsnZW5jcnlwdGVkJ10sICRibG9ja19zaXplKTsNCiRjaXBoZXJ0ZXh0Lj0gJGJsb2NrIF4gJGtleTsNCn0NCn0gZWxzZSB7DQpmb3IgKCRpID0gMDsgJGkgPCBzdHJsZW4oJHBsYWludGV4dCk7ICRpKz0kYmxvY2tfc2l6ZSkgew0KJGJsb2NrID0gc3Vic3RyKCRwbGFpbnRleHQsICRpLCAkYmxvY2tfc2l6ZSk7DQoka2V5ID0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJHRoaXMtPl9nZW5lcmF0ZV94b3IoJGJsb2NrX3NpemUsICR4b3IpKTsNCiRjaXBoZXJ0ZXh0Lj0gJGJsb2NrIF4gJGtleTsNCn0NCn0NCmlmICgkdGhpcy0+Y29udGludW91c0J1ZmZlcikgew0KJHRoaXMtPmVuY3J5cHRJViA9ICR4b3I7DQppZiAoJHN0YXJ0ID0gc3RybGVuKCRwbGFpbnRleHQpICUgJGJsb2NrX3NpemUpIHsNCiRidWZmZXJbJ2VuY3J5cHRlZCddID0gc3Vic3RyKCRrZXksICRzdGFydCkgLiAkYnVmZmVyWydlbmNyeXB0ZWQnXTsNCn0NCn0NCmJyZWFrOw0KY2FzZSBDUllQVF9SSUpOREFFTF9NT0RFX0NGQjoNCmlmICghZW1wdHkoJGJ1ZmZlclsneG9yJ10pKSB7DQokY2lwaGVydGV4dCA9ICRwbGFpbnRleHQgXiAkYnVmZmVyWyd4b3InXTsNCiRpdiA9ICRidWZmZXJbJ2VuY3J5cHRlZCddIC4gJGNpcGhlcnRleHQ7DQokc3RhcnQgPSBzdHJsZW4oJGNpcGhlcnRleHQpOw0KJGJ1ZmZlclsnZW5jcnlwdGVkJ10uPSAkY2lwaGVydGV4dDsNCiRidWZmZXJbJ3hvciddID0gc3Vic3RyKCRidWZmZXJbJ3hvciddLCBzdHJsZW4oJGNpcGhlcnRleHQpKTsNCn0gZWxzZSB7DQokY2lwaGVydGV4dCA9ICcnOw0KJGl2ID0gJHRoaXMtPmVuY3J5cHRJVjsNCiRzdGFydCA9IDA7DQp9DQoNCmZvciAoJGkgPSAkc3RhcnQ7ICRpIDwgc3RybGVuKCRwbGFpbnRleHQpOyAkaSs9JGJsb2NrX3NpemUpIHsNCiRibG9jayA9IHN1YnN0cigkcGxhaW50ZXh0LCAkaSwgJGJsb2NrX3NpemUpOw0KJHhvciA9ICR0aGlzLT5fZW5jcnlwdEJsb2NrKCRpdik7DQokaXYgPSAkYmxvY2sgXiAkeG9yOw0KaWYgKCRjb250aW51b3VzQnVmZmVyICYmIHN0cmxlbigkaXYpICE9ICRibG9ja19zaXplKSB7DQokYnVmZmVyID0gYXJyYXkoDQonZW5jcnlwdGVkJyA9PiAkaXYsDQoneG9yJyA9PiBzdWJzdHIoJHhvciwgc3RybGVuKCRpdikpDQopOw0KfQ0KJGNpcGhlcnRleHQuPSAkaXY7DQp9DQoNCmlmICgkdGhpcy0+Y29udGludW91c0J1ZmZlcikgew0KJHRoaXMtPmVuY3J5cHRJViA9ICRpdjsNCn0NCmJyZWFrOw0KY2FzZSBDUllQVF9SSUpOREFFTF9NT0RFX09GQjoNCiR4b3IgPSAkdGhpcy0+ZW5jcnlwdElWOw0KaWYgKHN0cmxlbigkYnVmZmVyKSkgew0KZm9yICgkaSA9IDA7ICRpIDwgc3RybGVuKCRwbGFpbnRleHQpOyAkaSs9JGJsb2NrX3NpemUpIHsNCiR4b3IgPSAkdGhpcy0+X2VuY3J5cHRCbG9jaygkeG9yKTsNCiRidWZmZXIuPSAkeG9yOw0KJGtleSA9ICR0aGlzLT5fc3RyaW5nX3NoaWZ0KCRidWZmZXIsICRibG9ja19zaXplKTsNCiRjaXBoZXJ0ZXh0Lj0gc3Vic3RyKCRwbGFpbnRleHQsICRpLCAkYmxvY2tfc2l6ZSkgXiAka2V5Ow0KfQ0KfSBlbHNlIHsNCmZvciAoJGkgPSAwOyAkaSA8IHN0cmxlbigkcGxhaW50ZXh0KTsgJGkrPSRibG9ja19zaXplKSB7DQokeG9yID0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJHhvcik7DQokY2lwaGVydGV4dC49IHN1YnN0cigkcGxhaW50ZXh0LCAkaSwgJGJsb2NrX3NpemUpIF4gJHhvcjsNCn0NCiRrZXkgPSAkeG9yOw0KfQ0KaWYgKCR0aGlzLT5jb250aW51b3VzQnVmZmVyKSB7DQokdGhpcy0+ZW5jcnlwdElWID0gJHhvcjsNCmlmICgkc3RhcnQgPSBzdHJsZW4oJHBsYWludGV4dCkgJSAkYmxvY2tfc2l6ZSkgew0KICRidWZmZXIgPSBzdWJzdHIoJGtleSwgJHN0YXJ0KSAuICRidWZmZXI7DQp9DQp9DQp9DQoNCnJldHVybiAkY2lwaGVydGV4dDsNCn0NCmZ1bmN0aW9uIGRlY3J5cHQoJGNpcGhlcnRleHQpDQp7DQokdGhpcy0+X3NldHVwKCk7DQoNCmlmICgkdGhpcy0+cGFkZGFibGUpIHsNCi8vIHdlIHBhZCB3aXRoIGNocigwKSBzaW5jZSB0aGF0J3Mgd2hhdCBtY3J5cHRfZ2VuZXJpYyBkb2VzLiAgdG8gcXVvdGUgZnJvbSBodHRwOi8vcGhwLm5ldC9mdW5jdGlvbi5tY3J5cHQtZ2VuZXJpYyA6DQovLyAiVGhlIGRhdGEgaXMgcGFkZGVkIHdpdGggIlwwIiB0byBtYWtlIHN1cmUgdGhlIGxlbmd0aCBvZiB0aGUgZGF0YSBpcyBuICogYmxvY2tzaXplLiINCiRjaXBoZXJ0ZXh0ID0gc3RyX3BhZCgkY2lwaGVydGV4dCwgc3RybGVuKCRjaXBoZXJ0ZXh0KSArICgkdGhpcy0+YmxvY2tfc2l6ZSAtIHN0cmxlbigkY2lwaGVydGV4dCkgJSAkdGhpcy0+YmxvY2tfc2l6ZSkgJSAkdGhpcy0+YmxvY2tfc2l6ZSwgY2hyKDApKTsNCn0NCg0KJGJsb2NrX3NpemUgPSAkdGhpcy0+YmxvY2tfc2l6ZTsNCiRidWZmZXIgPSAmJHRoaXMtPmRlYnVmZmVyOw0KJGNvbnRpbnVvdXNCdWZmZXIgPSAkdGhpcy0+Y29udGludW91c0J1ZmZlcjsNCiRwbGFpbnRleHQgPSAnJzsNCnN3aXRjaCAoJHRoaXMtPm1vZGUpIHsNCmNhc2UgQ1JZUFRfUklKTkRBRUxfTU9ERV9FQ0I6DQpmb3IgKCRpID0gMDsgJGkgPCBzdHJsZW4oJGNpcGhlcnRleHQpOyAkaSs9JGJsb2NrX3NpemUpIHsNCiRwbGFpbnRleHQuPSAkdGhpcy0+X2RlY3J5cHRCbG9jayhzdWJzdHIoJGNpcGhlcnRleHQsICRpLCAkYmxvY2tfc2l6ZSkpOw0KfQ0KYnJlYWs7DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfQ0JDOg0KJHhvciA9ICR0aGlzLT5kZWNyeXB0SVY7DQpmb3IgKCRpID0gMDsgJGkgPCBzdHJsZW4oJGNpcGhlcnRleHQpOyAkaSs9JGJsb2NrX3NpemUpIHsNCiRibG9jayA9IHN1YnN0cigkY2lwaGVydGV4dCwgJGksICRibG9ja19zaXplKTsNCiRwbGFpbnRleHQuPSAkdGhpcy0+X2RlY3J5cHRCbG9jaygkYmxvY2spIF4gJHhvcjsNCiR4b3IgPSAkYmxvY2s7DQp9DQppZiAoJHRoaXMtPmNvbnRpbnVvdXNCdWZmZXIpIHsNCiR0aGlzLT5kZWNyeXB0SVYgPSAkeG9yOw0KfQ0KYnJlYWs7DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfQ1RSOg0KJHhvciA9ICR0aGlzLT5kZWNyeXB0SVY7DQppZiAoIWVtcHR5KCRidWZmZXJbJ2NpcGhlcnRleHQnXSkpIHsNCmZvciAoJGkgPSAwOyAkaSA8IHN0cmxlbigkY2lwaGVydGV4dCk7ICRpKz0kYmxvY2tfc2l6ZSkgew0KJGJsb2NrID0gc3Vic3RyKCRjaXBoZXJ0ZXh0LCAkaSwgJGJsb2NrX3NpemUpOw0KJGJ1ZmZlclsnY2lwaGVydGV4dCddLj0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJHRoaXMtPl9nZW5lcmF0ZV94b3IoJGJsb2NrX3NpemUsICR4b3IpKTsNCiRrZXkgPSAkdGhpcy0+X3N0cmluZ19zaGlmdCgkYnVmZmVyWydjaXBoZXJ0ZXh0J10sICRibG9ja19zaXplKTsNCiRwbGFpbnRleHQuPSAkYmxvY2sgXiAka2V5Ow0KfQ0KfSBlbHNlIHsNCmZvciAoJGkgPSAwOyAkaSA8IHN0cmxlbigkY2lwaGVydGV4dCk7ICRpKz0kYmxvY2tfc2l6ZSkgew0KJGJsb2NrID0gc3Vic3RyKCRjaXBoZXJ0ZXh0LCAkaSwgJGJsb2NrX3NpemUpOw0KJGtleSA9ICR0aGlzLT5fZW5jcnlwdEJsb2NrKCR0aGlzLT5fZ2VuZXJhdGVfeG9yKCRibG9ja19zaXplLCAkeG9yKSk7DQokcGxhaW50ZXh0Lj0gJGJsb2NrIF4gJGtleTsNCn0NCn0NCmlmICgkdGhpcy0+Y29udGludW91c0J1ZmZlcikgew0KJHRoaXMtPmRlY3J5cHRJViA9ICR4b3I7DQppZiAoJHN0YXJ0ID0gc3RybGVuKCRjaXBoZXJ0ZXh0KSAlICRibG9ja19zaXplKSB7DQokYnVmZmVyWydjaXBoZXJ0ZXh0J10gPSBzdWJzdHIoJGtleSwgJHN0YXJ0KSAuICRidWZmZXJbJ2VuY3J5cHRlZCddOw0KfQ0KfQ0KYnJlYWs7DQpjYXNlIENSWVBUX1JJSk5EQUVMX01PREVfQ0ZCOg0KaWYgKCFlbXB0eSgkYnVmZmVyWydjaXBoZXJ0ZXh0J10pKSB7DQokcGxhaW50ZXh0ID0gJGNpcGhlcnRleHQgXiBzdWJzdHIoJHRoaXMtPmRlY3J5cHRJViwgc3RybGVuKCRidWZmZXJbJ2NpcGhlcnRleHQnXSkpOw0KJGJ1ZmZlclsnY2lwaGVydGV4dCddLj0gc3Vic3RyKCRjaXBoZXJ0ZXh0LCAwLCBzdHJsZW4oJHBsYWludGV4dCkpOw0KaWYgKHN0cmxlbigkYnVmZmVyWydjaXBoZXJ0ZXh0J10pID09ICRibG9ja19zaXplKSB7DQokeG9yID0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJGJ1ZmZlclsnY2lwaGVydGV4dCddKTsNCiRidWZmZXJbJ2NpcGhlcnRleHQnXSA9ICcnOw0KfQ0KJHN0YXJ0ID0gc3RybGVuKCRwbGFpbnRleHQpOw0KJGJsb2NrID0gJHRoaXMtPmRlY3J5cHRJVjsNCn0gZWxzZSB7DQokcGxhaW50ZXh0ID0gJyc7DQokeG9yID0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJHRoaXMtPmRlY3J5cHRJVik7DQokc3RhcnQgPSAwOw0KfQ0KDQpmb3IgKCRpID0gJHN0YXJ0OyAkaSA8IHN0cmxlbigkY2lwaGVydGV4dCk7ICRpKz0kYmxvY2tfc2l6ZSkgew0KJGJsb2NrID0gc3Vic3RyKCRjaXBoZXJ0ZXh0LCAkaSwgJGJsb2NrX3NpemUpOw0KJHBsYWludGV4dC49ICRibG9jayBeICR4b3I7DQppZiAoJGNvbnRpbnVvdXNCdWZmZXIgJiYgc3RybGVuKCRibG9jaykgIT0gJGJsb2NrX3NpemUpIHsNCiRidWZmZXJbJ2NpcGhlcnRleHQnXS49ICRibG9jazsNCiRibG9jayA9ICR4b3I7DQp9IGVsc2UgaWYgKHN0cmxlbigkYmxvY2spID09ICRibG9ja19zaXplKSB7DQokeG9yID0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJGJsb2NrKTsNCn0NCn0NCmlmICgkdGhpcy0+Y29udGludW91c0J1ZmZlcikgew0KJHRoaXMtPmRlY3J5cHRJViA9ICRibG9jazsNCn0NCmJyZWFrOw0KY2FzZSBDUllQVF9SSUpOREFFTF9NT0RFX09GQjoNCiR4b3IgPSAkdGhpcy0+ZGVjcnlwdElWOw0KaWYgKHN0cmxlbigkYnVmZmVyKSkgew0KZm9yICgkaSA9IDA7ICRpIDwgc3RybGVuKCRjaXBoZXJ0ZXh0KTsgJGkrPSRibG9ja19zaXplKSB7DQokeG9yID0gJHRoaXMtPl9lbmNyeXB0QmxvY2soJHhvcik7DQokYnVmZmVyLj0gJHhvcjsNCiRrZXkgPSAkdGhpcy0+X3N0cmluZ19zaGlmdCgkYnVmZmVyLCAkYmxvY2tfc2l6ZSk7DQokcGxhaW50ZXh0Lj0gc3Vic3RyKCRjaXBoZXJ0ZXh0LCAkaSwgJGJsb2NrX3NpemUpIF4gJGtleTsNCn0NCn0gZWxzZSB7DQpmb3IgKCRpID0gMDsgJGkgPCBzdHJsZW4oJGNpcGhlcnRleHQpOyAkaSs9JGJsb2NrX3NpemUpIHsNCiR4b3IgPSAkdGhpcy0+X2VuY3J5cHRCbG9jaygkeG9yKTsNCiRwbGFpbnRleHQuPSBzdWJzdHIoJGNpcGhlcnRleHQsICRpLCAkYmxvY2tfc2l6ZSkgXiAkeG9yOw0KfQ0KJGtleSA9ICR4b3I7DQp9DQppZiAoJHRoaXMtPmNvbnRpbnVvdXNCdWZmZXIpIHsNCiR0aGlzLT5kZWNyeXB0SVYgPSAkeG9yOw0KaWYgKCRzdGFydCA9IHN0cmxlbigkY2lwaGVydGV4dCkgJSAkYmxvY2tfc2l6ZSkgew0KICRidWZmZXIgPSBzdWJzdHIoJGtleSwgJHN0YXJ0KSAuICRidWZmZXI7DQp9DQp9DQp9DQoNCnJldHVybiAkdGhpcy0+cGFkZGFibGUgPyAkdGhpcy0+X3VucGFkKCRwbGFpbnRleHQpIDogJHBsYWludGV4dDsNCn0NCmZ1bmN0aW9uIF9lbmNyeXB0QmxvY2soJGluKQ0Kew0KJHN0YXRlID0gYXJyYXkoKTsNCiR3b3JkcyA9IHVucGFjaygnTip3b3JkJywgJGluKTsNCg0KJHcgPSAkdGhpcy0+dzsNCiR0MCA9ICR0aGlzLT50MDsNCiR0MSA9ICR0aGlzLT50MTsNCiR0MiA9ICR0aGlzLT50MjsNCiR0MyA9ICR0aGlzLT50MzsNCiROYiA9ICR0aGlzLT5OYjsNCiROciA9ICR0aGlzLT5OcjsNCiRjID0gJHRoaXMtPmM7DQoNCiRpID0gMDsNCmZvcmVhY2ggKCR3b3JkcyBhcyAkd29yZCkgew0KJHN0YXRlW10gPSAkd29yZCBeICR3WzBdWyRpKytdOw0KfQ0KJHRlbXAgPSBhcnJheSgpOw0KZm9yICgkcm91bmQgPSAxOyAkcm91bmQgPCAkTnI7ICRyb3VuZCsrKSB7DQokaSA9IDA7IC8vICRjWzBdID09IDANCiRqID0gJGNbMV07DQokayA9ICRjWzJdOw0KJGwgPSAkY1szXTsNCg0Kd2hpbGUgKCRpIDwgJHRoaXMtPk5iKSB7DQokdGVtcFskaV0gPSAkdDBbJHN0YXRlWyRpXSAmIDB4RkYwMDAwMDBdIF4gDQokdDFbJHN0YXRlWyRqXSAmIDB4MDBGRjAwMDBdIF4gDQokdDJbJHN0YXRlWyRrXSAmIDB4MDAwMEZGMDBdIF4gDQokdDNbJHN0YXRlWyRsXSAmIDB4MDAwMDAwRkZdIF4gDQokd1skcm91bmRdWyRpXTsNCiRpKys7DQokaiA9ICgkaiArIDEpICUgJE5iOw0KJGsgPSAoJGsgKyAxKSAlICROYjsNCiRsID0gKCRsICsgMSkgJSAkTmI7DQp9DQoNCmZvciAoJGkgPSAwOyAkaSA8ICROYjsgJGkrKykgew0KJHN0YXRlWyRpXSA9ICR0ZW1wWyRpXTsNCn0NCn0NCg0KZm9yICgkaSA9IDA7ICRpIDwgJE5iOyAkaSsrKSB7DQokc3RhdGVbJGldID0gJHRoaXMtPl9zdWJXb3JkKCRzdGF0ZVskaV0pOw0KfQ0KDQokaSA9IDA7DQokaiA9ICRjWzFdOw0KJGsgPSAkY1syXTsNCiRsID0gJGNbM107DQp3aGlsZSAoJGkgPCAkdGhpcy0+TmIpIHsNCiR0ZW1wWyRpXSA9ICgkc3RhdGVbJGldICYgMHhGRjAwMDAwMCkgXiANCigkc3RhdGVbJGpdICYgMHgwMEZGMDAwMCkgXiANCigkc3RhdGVbJGtdICYgMHgwMDAwRkYwMCkgXiANCigkc3RhdGVbJGxdICYgMHgwMDAwMDBGRikgXg0KICR3WyROcl1bJGldOw0KJGkrKzsNCiRqID0gKCRqICsgMSkgJSAkTmI7DQokayA9ICgkayArIDEpICUgJE5iOw0KJGwgPSAoJGwgKyAxKSAlICROYjsNCn0NCiRzdGF0ZSA9ICR0ZW1wOw0KDQphcnJheV91bnNoaWZ0KCRzdGF0ZSwgJ04qJyk7DQoNCnJldHVybiBjYWxsX3VzZXJfZnVuY19hcnJheSgncGFjaycsICRzdGF0ZSk7DQp9DQpmdW5jdGlvbiBfZGVjcnlwdEJsb2NrKCRpbikNCnsNCiRzdGF0ZSA9IGFycmF5KCk7DQokd29yZHMgPSB1bnBhY2soJ04qd29yZCcsICRpbik7DQoNCiRudW1fc3RhdGVzID0gY291bnQoJHN0YXRlKTsNCiRkdyA9ICR0aGlzLT5kdzsNCiRkdDAgPSAkdGhpcy0+ZHQwOw0KJGR0MSA9ICR0aGlzLT5kdDE7DQokZHQyID0gJHRoaXMtPmR0MjsNCiRkdDMgPSAkdGhpcy0+ZHQzOw0KJE5iID0gJHRoaXMtPk5iOw0KJE5yID0gJHRoaXMtPk5yOw0KJGMgPSAkdGhpcy0+YzsNCiRpID0gMDsNCmZvcmVhY2ggKCR3b3JkcyBhcyAkd29yZCkgew0KJHN0YXRlW10gPSAkd29yZCBeICRkd1skTnJdWyRpKytdOw0KfQ0KDQokdGVtcCA9IGFycmF5KCk7DQpmb3IgKCRyb3VuZCA9ICROciAtIDE7ICRyb3VuZCA+IDA7ICRyb3VuZC0tKSB7DQokaSA9IDA7DQokaiA9ICROYiAtICRjWzFdOw0KJGsgPSAkTmIgLSAkY1syXTsNCiRsID0gJE5iIC0gJGNbM107DQoNCndoaWxlICgkaSA8ICROYikgew0KJHRlbXBbJGldID0gJGR0MFskc3RhdGVbJGldICYgMHhGRjAwMDAwMF0gXiANCiRkdDFbJHN0YXRlWyRqXSAmIDB4MDBGRjAwMDBdIF4gDQokZHQyWyRzdGF0ZVska10gJiAweDAwMDBGRjAwXSBeIA0KJGR0M1skc3RhdGVbJGxdICYgMHgwMDAwMDBGRl0gXiANCiRkd1skcm91bmRdWyRpXTsNCiRpKys7DQokaiA9ICgkaiArIDEpICUgJE5iOw0KJGsgPSAoJGsgKyAxKSAlICROYjsNCiRsID0gKCRsICsgMSkgJSAkTmI7DQp9DQoNCmZvciAoJGkgPSAwOyAkaSA8ICROYjsgJGkrKykgew0KJHN0YXRlWyRpXSA9ICR0ZW1wWyRpXTsNCn0NCn0NCiRpID0gMDsNCiRqID0gJE5iIC0gJGNbMV07DQokayA9ICROYiAtICRjWzJdOw0KJGwgPSAkTmIgLSAkY1szXTsNCg0Kd2hpbGUgKCRpIDwgJE5iKSB7DQokdGVtcFskaV0gPSAkZHdbMF1bJGldIF4gDQokdGhpcy0+X2ludlN1YldvcmQoKCRzdGF0ZVskaV0gJiAweEZGMDAwMDAwKSB8IA0KICAgKCRzdGF0ZVskal0gJiAweDAwRkYwMDAwKSB8IA0KICAgKCRzdGF0ZVska10gJiAweDAwMDBGRjAwKSB8IA0KICAgKCRzdGF0ZVskbF0gJiAweDAwMDAwMEZGKSk7DQokaSsrOw0KJGogPSAoJGogKyAxKSAlICROYjsNCiRrID0gKCRrICsgMSkgJSAkTmI7DQokbCA9ICgkbCArIDEpICUgJE5iOw0KfQ0KDQokc3RhdGUgPSAkdGVtcDsNCg0KYXJyYXlfdW5zaGlmdCgkc3RhdGUsICdOKicpOw0KDQpyZXR1cm4gY2FsbF91c2VyX2Z1bmNfYXJyYXkoJ3BhY2snLCAkc3RhdGUpOw0KfQ0KDQpmdW5jdGlvbiBfc2V0dXAoKQ0Kew0Kc3RhdGljICRyY29uID0gYXJyYXkoMCwNCjB4MDEwMDAwMDAsIDB4MDIwMDAwMDAsIDB4MDQwMDAwMDAsIDB4MDgwMDAwMDAsIDB4MTAwMDAwMDAsDQoweDIwMDAwMDAwLCAweDQwMDAwMDAwLCAweDgwMDAwMDAwLCAweDFCMDAwMDAwLCAweDM2MDAwMDAwLA0KMHg2QzAwMDAwMCwgMHhEODAwMDAwMCwgMHhBQjAwMDAwMCwgMHg0RDAwMDAwMCwgMHg5QTAwMDAwMCwNCjB4MkYwMDAwMDAsIDB4NUUwMDAwMDAsIDB4QkMwMDAwMDAsIDB4NjMwMDAwMDAsIDB4QzYwMDAwMDAsDQoweDk3MDAwMDAwLCAweDM1MDAwMDAwLCAweDZBMDAwMDAwLCAweEQ0MDAwMDAwLCAweEIzMDAwMDAwLA0KMHg3RDAwMDAwMCwgMHhGQTAwMDAwMCwgMHhFRjAwMDAwMCwgMHhDNTAwMDAwMCwgMHg5MTAwMDAwMA0KKTsNCg0KaWYgKCEkdGhpcy0+Y2hhbmdlZCkgew0KcmV0dXJuOw0KfQ0KDQppZiAoISR0aGlzLT5leHBsaWNpdF9rZXlfbGVuZ3RoKSB7DQokbGVuZ3RoID0gc3RybGVuKCR0aGlzLT5rZXkpID4+IDI7DQppZiAoJGxlbmd0aCA+IDgpIHsNCiRsZW5ndGggPSA4Ow0KfSBlbHNlIGlmICgkbGVuZ3RoIDwgNCkgew0KJGxlbmd0aCA9IDQ7DQp9DQokdGhpcy0+TmsgPSAkbGVuZ3RoOw0KJHRoaXMtPmtleV9zaXplID0gJGxlbmd0aCA8PCAyOw0KfQ0KDQokdGhpcy0+a2V5ID0gc3RyX3BhZChzdWJzdHIoJHRoaXMtPmtleSwgMCwgJHRoaXMtPmtleV9zaXplKSwgJHRoaXMtPmtleV9zaXplLCBjaHIoMCkpOw0KJHRoaXMtPmVuY3J5cHRJViA9ICR0aGlzLT5kZWNyeXB0SVYgPSAkdGhpcy0+aXYgPSBzdHJfcGFkKHN1YnN0cigkdGhpcy0+aXYsIDAsICR0aGlzLT5ibG9ja19zaXplKSwgJHRoaXMtPmJsb2NrX3NpemUsIGNocigwKSk7DQoNCiR0aGlzLT5OciA9IG1heCgkdGhpcy0+TmssICR0aGlzLT5OYikgKyA2Ow0KDQpzd2l0Y2ggKCR0aGlzLT5OYikgew0KY2FzZSA0Og0KY2FzZSA1Og0KY2FzZSA2Og0KJHRoaXMtPmMgPSBhcnJheSgwLCAxLCAyLCAzKTsNCmJyZWFrOw0KY2FzZSA3Og0KJHRoaXMtPmMgPSBhcnJheSgwLCAxLCAyLCA0KTsNCmJyZWFrOw0KY2FzZSA4Og0KJHRoaXMtPmMgPSBhcnJheSgwLCAxLCAzLCA0KTsNCn0NCg0KJGtleSA9ICR0aGlzLT5rZXk7DQoNCiR3ID0gYXJyYXlfdmFsdWVzKHVucGFjaygnTip3b3JkcycsICRrZXkpKTsNCg0KJGxlbmd0aCA9ICR0aGlzLT5OYiAqICgkdGhpcy0+TnIgKyAxKTsNCmZvciAoJGkgPSAkdGhpcy0+Tms7ICRpIDwgJGxlbmd0aDsgJGkrKykgew0KJHRlbXAgPSAkd1skaSAtIDFdOw0KaWYgKCRpICUgJHRoaXMtPk5rID09IDApIHsNCiR0ZW1wID0gKCgkdGVtcCA8PCA4KSAmIDB4RkZGRkZGMDApIHwgKCgkdGVtcCA+PiAyNCkgJiAweDAwMDAwMEZGKTsNCiR0ZW1wID0gJHRoaXMtPl9zdWJXb3JkKCR0ZW1wKSBeICRyY29uWyRpIC8gJHRoaXMtPk5rXTsNCn0gZWxzZSBpZiAoJHRoaXMtPk5rID4gNiAmJiAkaSAlICR0aGlzLT5OayA9PSA0KSB7DQokdGVtcCA9ICR0aGlzLT5fc3ViV29yZCgkdGVtcCk7DQp9DQokd1skaV0gPSAkd1skaSAtICR0aGlzLT5Oa10gXiAkdGVtcDsNCn0NCiR0ZW1wID0gYXJyYXkoKTsNCmZvciAoJGkgPSAkcm93ID0gJGNvbCA9IDA7ICRpIDwgJGxlbmd0aDsgJGkrKywgJGNvbCsrKSB7DQppZiAoJGNvbCA9PSAkdGhpcy0+TmIpIHsNCmlmICgkcm93ID09IDApIHsNCiR0aGlzLT5kd1swXSA9ICR0aGlzLT53WzBdOw0KfSBlbHNlIHsNCiRqID0gMDsNCndoaWxlICgkaiA8ICR0aGlzLT5OYikgew0KJGR3ID0gJHRoaXMtPl9zdWJXb3JkKCR0aGlzLT53WyRyb3ddWyRqXSk7DQokdGVtcFskal0gPSAkdGhpcy0+ZHQwWyRkdyAmIDB4RkYwMDAwMDBdIF4gDQokdGhpcy0+ZHQxWyRkdyAmIDB4MDBGRjAwMDBdIF4gDQokdGhpcy0+ZHQyWyRkdyAmIDB4MDAwMEZGMDBdIF4gDQokdGhpcy0+ZHQzWyRkdyAmIDB4MDAwMDAwRkZdOw0KJGorKzsNCn0NCiR0aGlzLT5kd1skcm93XSA9ICR0ZW1wOw0KfQ0KDQokY29sID0gMDsNCiRyb3crKzsNCn0NCiR0aGlzLT53WyRyb3ddWyRjb2xdID0gJHdbJGldOw0KfQ0KDQokdGhpcy0+ZHdbJHJvd10gPSAkdGhpcy0+d1skcm93XTsNCg0KJHRoaXMtPmNoYW5nZWQgPSBmYWxzZTsNCn0NCmZ1bmN0aW9uIF9zdWJXb3JkKCR3b3JkKQ0Kew0Kc3RhdGljICRzYm94MCwgJHNib3gxLCAkc2JveDIsICRzYm94MzsNCg0KaWYgKGVtcHR5KCRzYm94MCkpIHsNCiRzYm94MCA9IGFycmF5KA0KMHg2MywgMHg3QywgMHg3NywgMHg3QiwgMHhGMiwgMHg2QiwgMHg2RiwgMHhDNSwgMHgzMCwgMHgwMSwgMHg2NywgMHgyQiwgMHhGRSwgMHhENywgMHhBQiwgMHg3NiwNCjB4Q0EsIDB4ODIsIDB4QzksIDB4N0QsIDB4RkEsIDB4NTksIDB4NDcsIDB4RjAsIDB4QUQsIDB4RDQsIDB4QTIsIDB4QUYsIDB4OUMsIDB4QTQsIDB4NzIsIDB4QzAsDQoweEI3LCAweEZELCAweDkzLCAweDI2LCAweDM2LCAweDNGLCAweEY3LCAweENDLCAweDM0LCAweEE1LCAweEU1LCAweEYxLCAweDcxLCAweEQ4LCAweDMxLCAweDE1LA0KMHgwNCwgMHhDNywgMHgyMywgMHhDMywgMHgxOCwgMHg5NiwgMHgwNSwgMHg5QSwgMHgwNywgMHgxMiwgMHg4MCwgMHhFMiwgMHhFQiwgMHgyNywgMHhCMiwgMHg3NSwNCjB4MDksIDB4ODMsIDB4MkMsIDB4MUEsIDB4MUIsIDB4NkUsIDB4NUEsIDB4QTAsIDB4NTIsIDB4M0IsIDB4RDYsIDB4QjMsIDB4MjksIDB4RTMsIDB4MkYsIDB4ODQsDQoweDUzLCAweEQxLCAweDAwLCAweEVELCAweDIwLCAweEZDLCAweEIxLCAweDVCLCAweDZBLCAweENCLCAweEJFLCAweDM5LCAweDRBLCAweDRDLCAweDU4LCAweENGLA0KMHhEMCwgMHhFRiwgMHhBQSwgMHhGQiwgMHg0MywgMHg0RCwgMHgzMywgMHg4NSwgMHg0NSwgMHhGOSwgMHgwMiwgMHg3RiwgMHg1MCwgMHgzQywgMHg5RiwgMHhBOCwNCjB4NTEsIDB4QTMsIDB4NDAsIDB4OEYsIDB4OTIsIDB4OUQsIDB4MzgsIDB4RjUsIDB4QkMsIDB4QjYsIDB4REEsIDB4MjEsIDB4MTAsIDB4RkYsIDB4RjMsIDB4RDIsDQoweENELCAweDBDLCAweDEzLCAweEVDLCAweDVGLCAweDk3LCAweDQ0LCAweDE3LCAweEM0LCAweEE3LCAweDdFLCAweDNELCAweDY0LCAweDVELCAweDE5LCAweDczLA0KMHg2MCwgMHg4MSwgMHg0RiwgMHhEQywgMHgyMiwgMHgyQSwgMHg5MCwgMHg4OCwgMHg0NiwgMHhFRSwgMHhCOCwgMHgxNCwgMHhERSwgMHg1RSwgMHgwQiwgMHhEQiwNCjB4RTAsIDB4MzIsIDB4M0EsIDB4MEEsIDB4NDksIDB4MDYsIDB4MjQsIDB4NUMsIDB4QzIsIDB4RDMsIDB4QUMsIDB4NjIsIDB4OTEsIDB4OTUsIDB4RTQsIDB4NzksDQoweEU3LCAweEM4LCAweDM3LCAweDZELCAweDhELCAweEQ1LCAweDRFLCAweEE5LCAweDZDLCAweDU2LCAweEY0LCAweEVBLCAweDY1LCAweDdBLCAweEFFLCAweDA4LA0KMHhCQSwgMHg3OCwgMHgyNSwgMHgyRSwgMHgxQywgMHhBNiwgMHhCNCwgMHhDNiwgMHhFOCwgMHhERCwgMHg3NCwgMHgxRiwgMHg0QiwgMHhCRCwgMHg4QiwgMHg4QSwNCjB4NzAsIDB4M0UsIDB4QjUsIDB4NjYsIDB4NDgsIDB4MDMsIDB4RjYsIDB4MEUsIDB4NjEsIDB4MzUsIDB4NTcsIDB4QjksIDB4ODYsIDB4QzEsIDB4MUQsIDB4OUUsDQoweEUxLCAweEY4LCAweDk4LCAweDExLCAweDY5LCAweEQ5LCAweDhFLCAweDk0LCAweDlCLCAweDFFLCAweDg3LCAweEU5LCAweENFLCAweDU1LCAweDI4LCAweERGLA0KMHg4QywgMHhBMSwgMHg4OSwgMHgwRCwgMHhCRiwgMHhFNiwgMHg0MiwgMHg2OCwgMHg0MSwgMHg5OSwgMHgyRCwgMHgwRiwgMHhCMCwgMHg1NCwgMHhCQiwgMHgxNg0KKTsNCg0KJHNib3gxID0gYXJyYXkoKTsNCiRzYm94MiA9IGFycmF5KCk7DQokc2JveDMgPSBhcnJheSgpOw0KDQpmb3IgKCRpID0gMDsgJGkgPCAyNTY7ICRpKyspIHsNCiRzYm94MVskaSA8PCAgOF0gPSAkc2JveDBbJGldIDw8ICA4Ow0KJHNib3gyWyRpIDw8IDE2XSA9ICRzYm94MFskaV0gPDwgMTY7DQokc2JveDNbJGkgPDwgMjRdID0gJHNib3gwWyRpXSA8PCAyNDsNCn0NCn0NCg0KcmV0dXJuICRzYm94MFskd29yZCAmIDB4MDAwMDAwRkZdIHwgDQogICAkc2JveDFbJHdvcmQgJiAweDAwMDBGRjAwXSB8IA0KICAgJHNib3gyWyR3b3JkICYgMHgwMEZGMDAwMF0gfCANCiAgICRzYm94M1skd29yZCAmIDB4RkYwMDAwMDBdOw0KfQ0KZnVuY3Rpb24gX2ludlN1YldvcmQoJHdvcmQpDQp7DQpzdGF0aWMgJHNib3gwLCAkc2JveDEsICRzYm94MiwgJHNib3gzOw0KDQppZiAoZW1wdHkoJHNib3gwKSkgew0KJHNib3gwID0gYXJyYXkoDQoweDUyLCAweDA5LCAweDZBLCAweEQ1LCAweDMwLCAweDM2LCAweEE1LCAweDM4LCAweEJGLCAweDQwLCAweEEzLCAweDlFLCAweDgxLCAweEYzLCAweEQ3LCAweEZCLA0KMHg3QywgMHhFMywgMHgzOSwgMHg4MiwgMHg5QiwgMHgyRiwgMHhGRiwgMHg4NywgMHgzNCwgMHg4RSwgMHg0MywgMHg0NCwgMHhDNCwgMHhERSwgMHhFOSwgMHhDQiwNCjB4NTQsIDB4N0IsIDB4OTQsIDB4MzIsIDB4QTYsIDB4QzIsIDB4MjMsIDB4M0QsIDB4RUUsIDB4NEMsIDB4OTUsIDB4MEIsIDB4NDIsIDB4RkEsIDB4QzMsIDB4NEUsDQoweDA4LCAweDJFLCAweEExLCAweDY2LCAweDI4LCAweEQ5LCAweDI0LCAweEIyLCAweDc2LCAweDVCLCAweEEyLCAweDQ5LCAweDZELCAweDhCLCAweEQxLCAweDI1LA0KMHg3MiwgMHhGOCwgMHhGNiwgMHg2NCwgMHg4NiwgMHg2OCwgMHg5OCwgMHgxNiwgMHhENCwgMHhBNCwgMHg1QywgMHhDQywgMHg1RCwgMHg2NSwgMHhCNiwgMHg5MiwNCjB4NkMsIDB4NzAsIDB4NDgsIDB4NTAsIDB4RkQsIDB4RUQsIDB4QjksIDB4REEsIDB4NUUsIDB4MTUsIDB4NDYsIDB4NTcsIDB4QTcsIDB4OEQsIDB4OUQsIDB4ODQsDQoweDkwLCAweEQ4LCAweEFCLCAweDAwLCAweDhDLCAweEJDLCAweEQzLCAweDBBLCAweEY3LCAweEU0LCAweDU4LCAweDA1LCAweEI4LCAweEIzLCAweDQ1LCAweDA2LA0KMHhEMCwgMHgyQywgMHgxRSwgMHg4RiwgMHhDQSwgMHgzRiwgMHgwRiwgMHgwMiwgMHhDMSwgMHhBRiwgMHhCRCwgMHgwMywgMHgwMSwgMHgxMywgMHg4QSwgMHg2QiwNCjB4M0EsIDB4OTEsIDB4MTEsIDB4NDEsIDB4NEYsIDB4NjcsIDB4REMsIDB4RUEsIDB4OTcsIDB4RjIsIDB4Q0YsIDB4Q0UsIDB4RjAsIDB4QjQsIDB4RTYsIDB4NzMsDQoweDk2LCAweEFDLCAweDc0LCAweDIyLCAweEU3LCAweEFELCAweDM1LCAweDg1LCAweEUyLCAweEY5LCAweDM3LCAweEU4LCAweDFDLCAweDc1LCAweERGLCAweDZFLA0KMHg0NywgMHhGMSwgMHgxQSwgMHg3MSwgMHgxRCwgMHgyOSwgMHhDNSwgMHg4OSwgMHg2RiwgMHhCNywgMHg2MiwgMHgwRSwgMHhBQSwgMHgxOCwgMHhCRSwgMHgxQiwNCjB4RkMsIDB4NTYsIDB4M0UsIDB4NEIsIDB4QzYsIDB4RDIsIDB4NzksIDB4MjAsIDB4OUEsIDB4REIsIDB4QzAsIDB4RkUsIDB4NzgsIDB4Q0QsIDB4NUEsIDB4RjQsDQoweDFGLCAweERELCAweEE4LCAweDMzLCAweDg4LCAweDA3LCAweEM3LCAweDMxLCAweEIxLCAweDEyLCAweDEwLCAweDU5LCAweDI3LCAweDgwLCAweEVDLCAweDVGLA0KMHg2MCwgMHg1MSwgMHg3RiwgMHhBOSwgMHgxOSwgMHhCNSwgMHg0QSwgMHgwRCwgMHgyRCwgMHhFNSwgMHg3QSwgMHg5RiwgMHg5MywgMHhDOSwgMHg5QywgMHhFRiwNCjB4QTAsIDB4RTAsIDB4M0IsIDB4NEQsIDB4QUUsIDB4MkEsIDB4RjUsIDB4QjAsIDB4QzgsIDB4RUIsIDB4QkIsIDB4M0MsIDB4ODMsIDB4NTMsIDB4OTksIDB4NjEsDQoweDE3LCAweDJCLCAweDA0LCAweDdFLCAweEJBLCAweDc3LCAweEQ2LCAweDI2LCAweEUxLCAweDY5LCAweDE0LCAweDYzLCAweDU1LCAweDIxLCAweDBDLCAweDdEDQopOw0KDQokc2JveDEgPSBhcnJheSgpOw0KJHNib3gyID0gYXJyYXkoKTsNCiRzYm94MyA9IGFycmF5KCk7DQoNCmZvciAoJGkgPSAwOyAkaSA8IDI1NjsgJGkrKykgew0KJHNib3gxWyRpIDw8ICA4XSA9ICRzYm94MFskaV0gPDwgIDg7DQokc2JveDJbJGkgPDwgMTZdID0gJHNib3gwWyRpXSA8PCAxNjsNCiRzYm94M1skaSA8PCAyNF0gPSAkc2JveDBbJGldIDw8IDI0Ow0KfQ0KfQ0KDQpyZXR1cm4gJHNib3gwWyR3b3JkICYgMHgwMDAwMDBGRl0gfCANCiAgICRzYm94MVskd29yZCAmIDB4MDAwMEZGMDBdIHwgDQogICAkc2JveDJbJHdvcmQgJiAweDAwRkYwMDAwXSB8IA0KICAgJHNib3gzWyR3b3JkICYgMHhGRjAwMDAwMF07DQp9DQpmdW5jdGlvbiBlbmFibGVQYWRkaW5nKCkNCnsNCiR0aGlzLT5wYWRkaW5nID0gdHJ1ZTsNCn0NCmZ1bmN0aW9uIGRpc2FibGVQYWRkaW5nKCkNCnsNCiR0aGlzLT5wYWRkaW5nID0gZmFsc2U7DQp9DQpmdW5jdGlvbiBfcGFkKCR0ZXh0KQ0Kew0KJGxlbmd0aCA9IHN0cmxlbigkdGV4dCk7DQoNCmlmICghJHRoaXMtPnBhZGRpbmcpIHsNCmlmICgkbGVuZ3RoICUgJHRoaXMtPmJsb2NrX3NpemUgPT0gMCkgew0KcmV0dXJuICR0ZXh0Ow0KfSBlbHNlIHsNCnVzZXJfZXJyb3IoIlRoZSBwbGFpbnRleHQncyBsZW5ndGggKCRsZW5ndGgpIGlzIG5vdCBhIG11bHRpcGxlIG9mIHRoZSBibG9jayBzaXplICh7JHRoaXMtPmJsb2NrX3NpemV9KSIsIEVfVVNFUl9OT1RJQ0UpOw0KJHRoaXMtPnBhZGRpbmcgPSB0cnVlOw0KfQ0KfQ0KDQokcGFkID0gJHRoaXMtPmJsb2NrX3NpemUgLSAoJGxlbmd0aCAlICR0aGlzLT5ibG9ja19zaXplKTsNCg0KcmV0dXJuIHN0cl9wYWQoJHRleHQsICRsZW5ndGggKyAkcGFkLCBjaHIoJHBhZCkpOw0KfQ0KZnVuY3Rpb24gX3VucGFkKCR0ZXh0KQ0Kew0KaWYgKCEkdGhpcy0+cGFkZGluZykgew0KcmV0dXJuICR0ZXh0Ow0KfQ0KDQokbGVuZ3RoID0gb3JkKCR0ZXh0W3N0cmxlbigkdGV4dCkgLSAxXSk7DQoNCmlmICghJGxlbmd0aCB8fCAkbGVuZ3RoID4gJHRoaXMtPmJsb2NrX3NpemUpIHsNCnJldHVybiBmYWxzZTsNCn0NCg0KcmV0dXJuIHN1YnN0cigkdGV4dCwgMCwgLSRsZW5ndGgpOw0KfQ0KZnVuY3Rpb24gZW5hYmxlQ29udGludW91c0J1ZmZlcigpDQp7DQokdGhpcy0+Y29udGludW91c0J1ZmZlciA9IHRydWU7DQp9DQpmdW5jdGlvbiBkaXNhYmxlQ29udGludW91c0J1ZmZlcigpDQp7DQokdGhpcy0+Y29udGludW91c0J1ZmZlciA9IGZhbHNlOw0KJHRoaXMtPmVuY3J5cHRJViA9ICR0aGlzLT5pdjsNCiR0aGlzLT5kZWNyeXB0SVYgPSAkdGhpcy0+aXY7DQp9DQpmdW5jdGlvbiBfc3RyaW5nX3NoaWZ0KCYkc3RyaW5nLCAkaW5kZXggPSAxKQ0Kew0KJHN1YnN0ciA9IHN1YnN0cigkc3RyaW5nLCAwLCAkaW5kZXgpOw0KJHN0cmluZyA9IHN1YnN0cigkc3RyaW5nLCAkaW5kZXgpOw0KcmV0dXJuICRzdWJzdHI7DQp9DQp9DQoNCmRlZmluZSgnQ1JZUFRfQUVTX01PREVfQ1RSJywgLTEpOw0KZGVmaW5lKCdDUllQVF9BRVNfTU9ERV9FQ0InLCAxKTsNCmRlZmluZSgnQ1JZUFRfQUVTX01PREVfQ0JDJywgMik7DQpkZWZpbmUoJ0NSWVBUX0FFU19NT0RFX0NGQicsIDMpOw0KZGVmaW5lKCdDUllQVF9BRVNfTU9ERV9PRkInLCA0KTsNCmRlZmluZSgnQ1JZUFRfQUVTX01PREVfSU5URVJOQUwnLCAxKTsNCmRlZmluZSgnQ1JZUFRfQUVTX01PREVfTUNSWVBUJywgMik7DQpjbGFzcyBDcnlwdF9BRVMgZXh0ZW5kcyBDcnlwdF9SaWpuZGFlbCB7DQp2YXIgJGVubWNyeXB0Ow0KdmFyICRkZW1jcnlwdDsNCnZhciAkZWNiOw0KZnVuY3Rpb24gQ3J5cHRfQUVTKCRtb2RlID0gQ1JZUFRfQUVTX01PREVfQ0JDKQ0Kew0KaWYgKCAhZGVmaW5lZCgnQ1JZUFRfQUVTX01PREUnKSApIHsNCnN3aXRjaCAodHJ1ZSkgew0KY2FzZSBleHRlbnNpb25fbG9hZGVkKCdtY3J5cHQnKSAmJiBpbl9hcnJheSgncmlqbmRhZWwtMTI4JywgbWNyeXB0X2xpc3RfYWxnb3JpdGhtcygpKToNCmRlZmluZSgnQ1JZUFRfQUVTX01PREUnLCBDUllQVF9BRVNfTU9ERV9NQ1JZUFQpOw0KYnJlYWs7DQpkZWZhdWx0Og0KZGVmaW5lKCdDUllQVF9BRVNfTU9ERScsIENSWVBUX0FFU19NT0RFX0lOVEVSTkFMKTsNCn0NCn0NCg0Kc3dpdGNoICggQ1JZUFRfQUVTX01PREUgKSB7DQpjYXNlIENSWVBUX0FFU19NT0RFX01DUllQVDoNCnN3aXRjaCAoJG1vZGUpIHsNCmNhc2UgQ1JZUFRfQUVTX01PREVfRUNCOg0KJHRoaXMtPnBhZGRhYmxlID0gdHJ1ZTsNCiR0aGlzLT5tb2RlID0gTUNSWVBUX01PREVfRUNCOw0KYnJlYWs7DQpjYXNlIENSWVBUX0FFU19NT0RFX0NUUjoNCiR0aGlzLT5tb2RlID0gJ2N0cic7DQpicmVhazsNCmNhc2UgQ1JZUFRfQUVTX01PREVfQ0ZCOg0KJHRoaXMtPm1vZGUgPSAnbmNmYic7DQpicmVhazsNCmNhc2UgQ1JZUFRfQUVTX01PREVfT0ZCOg0KJHRoaXMtPm1vZGUgPSBNQ1JZUFRfTU9ERV9OT0ZCOw0KYnJlYWs7DQpjYXNlIENSWVBUX0FFU19NT0RFX0NCQzoNCmRlZmF1bHQ6DQokdGhpcy0+cGFkZGFibGUgPSB0cnVlOw0KJHRoaXMtPm1vZGUgPSBNQ1JZUFRfTU9ERV9DQkM7DQp9DQoNCiR0aGlzLT5kZWJ1ZmZlciA9ICR0aGlzLT5lbmJ1ZmZlciA9ICcnOw0KDQpicmVhazsNCmRlZmF1bHQ6DQpzd2l0Y2ggKCRtb2RlKSB7DQpjYXNlIENSWVBUX0FFU19NT0RFX0VDQjoNCiR0aGlzLT5wYWRkYWJsZSA9IHRydWU7DQokdGhpcy0+bW9kZSA9IENSWVBUX1JJSk5EQUVMX01PREVfRUNCOw0KYnJlYWs7DQpjYXNlIENSWVBUX0FFU19NT0RFX0NUUjoNCiR0aGlzLT5tb2RlID0gQ1JZUFRfUklKTkRBRUxfTU9ERV9DVFI7DQpicmVhazsNCmNhc2UgQ1JZUFRfQUVTX01PREVfQ0ZCOg0KJHRoaXMtPm1vZGUgPSBDUllQVF9SSUpOREFFTF9NT0RFX0NGQjsNCmJyZWFrOw0KY2FzZSBDUllQVF9BRVNfTU9ERV9PRkI6DQokdGhpcy0+bW9kZSA9IENSWVBUX1JJSk5EQUVMX01PREVfT0ZCOw0KYnJlYWs7DQpjYXNlIENSWVBUX0FFU19NT0RFX0NCQzoNCmRlZmF1bHQ6DQokdGhpcy0+cGFkZGFibGUgPSB0cnVlOw0KJHRoaXMtPm1vZGUgPSBDUllQVF9SSUpOREFFTF9NT0RFX0NCQzsNCn0NCn0NCg0KaWYgKENSWVBUX0FFU19NT0RFID09IENSWVBUX0FFU19NT0RFX0lOVEVSTkFMKSB7DQpwYXJlbnQ6OkNyeXB0X1Jpam5kYWVsKCR0aGlzLT5tb2RlKTsNCn0NCn0NCmZ1bmN0aW9uIHNldEJsb2NrTGVuZ3RoKCRsZW5ndGgpDQp7DQpyZXR1cm47DQp9DQpmdW5jdGlvbiBzZXRJVigkaXYpDQp7DQpwYXJlbnQ6OnNldElWKCRpdik7DQppZiAoIENSWVBUX0FFU19NT0RFID09IENSWVBUX0FFU19NT0RFX01DUllQVCApIHsNCiR0aGlzLT5jaGFuZ2VkID0gdHJ1ZTsNCn0NCn0NCmZ1bmN0aW9uIGVuY3J5cHQoJHBsYWludGV4dCkNCnsNCmlmICggQ1JZUFRfQUVTX01PREUgPT0gQ1JZUFRfQUVTX01PREVfTUNSWVBUICkgew0KJGNoYW5nZWQgPSAkdGhpcy0+Y2hhbmdlZDsNCiR0aGlzLT5fbWNyeXB0U2V0dXAoKTsNCmlmICgkdGhpcy0+bW9kZSA9PSAnbmNmYicpIHsNCmlmICgkY2hhbmdlZCkgew0KJHRoaXMtPmVjYiA9IG1jcnlwdF9tb2R1bGVfb3BlbihNQ1JZUFRfUklKTkRBRUxfMTI4LCAnJywgTUNSWVBUX01PREVfRUNCLCAnJyk7DQptY3J5cHRfZ2VuZXJpY19pbml0KCR0aGlzLT5lY2IsICR0aGlzLT5rZXksICJcMFwwXDBcMFwwXDBcMFwwXDBcMFwwXDBcMFwwXDBcMCIpOw0KfQ0KDQppZiAoc3RybGVuKCR0aGlzLT5lbmJ1ZmZlcikpIHsNCiRjaXBoZXJ0ZXh0ID0gJHBsYWludGV4dCBeIHN1YnN0cigkdGhpcy0+ZW5jcnlwdElWLCBzdHJsZW4oJHRoaXMtPmVuYnVmZmVyKSk7DQokdGhpcy0+ZW5idWZmZXIuPSAkY2lwaGVydGV4dDsNCmlmIChzdHJsZW4oJHRoaXMtPmVuYnVmZmVyKSA9PSAxNikgew0KJHRoaXMtPmVuY3J5cHRJViA9ICR0aGlzLT5lbmJ1ZmZlcjsNCiR0aGlzLT5lbmJ1ZmZlciA9ICcnOw0KbWNyeXB0X2dlbmVyaWNfaW5pdCgkdGhpcy0+ZW5tY3J5cHQsICR0aGlzLT5rZXksICR0aGlzLT5lbmNyeXB0SVYpOw0KfQ0KJHBsYWludGV4dCA9IHN1YnN0cigkcGxhaW50ZXh0LCBzdHJsZW4oJGNpcGhlcnRleHQpKTsNCn0gZWxzZSB7DQokY2lwaGVydGV4dCA9ICcnOw0KfQ0KDQokbGFzdF9wb3MgPSBzdHJsZW4oJHBsYWludGV4dCkgJiAweEZGRkZGRkYwOw0KJGNpcGhlcnRleHQuPSAkbGFzdF9wb3MgPyBtY3J5cHRfZ2VuZXJpYygkdGhpcy0+ZW5tY3J5cHQsIHN1YnN0cigkcGxhaW50ZXh0LCAwLCAkbGFzdF9wb3MpKSA6ICcnOw0KDQppZiAoc3RybGVuKCRwbGFpbnRleHQpICYgMHhGKSB7DQppZiAoc3RybGVuKCRjaXBoZXJ0ZXh0KSkgew0KJHRoaXMtPmVuY3J5cHRJViA9IHN1YnN0cigkY2lwaGVydGV4dCwgLTE2KTsNCn0NCiR0aGlzLT5lbmNyeXB0SVYgPSBtY3J5cHRfZ2VuZXJpYygkdGhpcy0+ZWNiLCAkdGhpcy0+ZW5jcnlwdElWKTsNCiR0aGlzLT5lbmJ1ZmZlciA9IHN1YnN0cigkcGxhaW50ZXh0LCAkbGFzdF9wb3MpIF4gJHRoaXMtPmVuY3J5cHRJVjsNCiRjaXBoZXJ0ZXh0Lj0gJHRoaXMtPmVuYnVmZmVyOw0KfQ0KDQpyZXR1cm4gJGNpcGhlcnRleHQ7DQp9DQoNCmlmICgkdGhpcy0+cGFkZGFibGUpIHsNCiRwbGFpbnRleHQgPSAkdGhpcy0+X3BhZCgkcGxhaW50ZXh0KTsNCn0NCg0KJGNpcGhlcnRleHQgPSBtY3J5cHRfZ2VuZXJpYygkdGhpcy0+ZW5tY3J5cHQsICRwbGFpbnRleHQpOw0KDQppZiAoISR0aGlzLT5jb250aW51b3VzQnVmZmVyKSB7DQptY3J5cHRfZ2VuZXJpY19pbml0KCR0aGlzLT5lbm1jcnlwdCwgJHRoaXMtPmtleSwgJHRoaXMtPml2KTsNCn0NCg0KcmV0dXJuICRjaXBoZXJ0ZXh0Ow0KfQ0KDQpyZXR1cm4gcGFyZW50OjplbmNyeXB0KCRwbGFpbnRleHQpOw0KfQ0KZnVuY3Rpb24gZGVjcnlwdCgkY2lwaGVydGV4dCkNCnsNCmlmICggQ1JZUFRfQUVTX01PREUgPT0gQ1JZUFRfQUVTX01PREVfTUNSWVBUICkgew0KJGNoYW5nZWQgPSAkdGhpcy0+Y2hhbmdlZDsNCiR0aGlzLT5fbWNyeXB0U2V0dXAoKTsNCmlmICgkdGhpcy0+bW9kZSA9PSAnbmNmYicpIHsNCmlmICgkY2hhbmdlZCkgew0KJHRoaXMtPmVjYiA9IG1jcnlwdF9tb2R1bGVfb3BlbihNQ1JZUFRfUklKTkRBRUxfMTI4LCAnJywgTUNSWVBUX01PREVfRUNCLCAnJyk7DQptY3J5cHRfZ2VuZXJpY19pbml0KCR0aGlzLT5lY2IsICR0aGlzLT5rZXksICJcMFwwXDBcMFwwXDBcMFwwXDBcMFwwXDBcMFwwXDBcMCIpOw0KfQ0KDQppZiAoc3RybGVuKCR0aGlzLT5kZWJ1ZmZlcikpIHsNCiRwbGFpbnRleHQgPSAkY2lwaGVydGV4dCBeIHN1YnN0cigkdGhpcy0+ZGVjcnlwdElWLCBzdHJsZW4oJHRoaXMtPmRlYnVmZmVyKSk7DQoNCiR0aGlzLT5kZWJ1ZmZlci49IHN1YnN0cigkY2lwaGVydGV4dCwgMCwgc3RybGVuKCRwbGFpbnRleHQpKTsNCmlmIChzdHJsZW4oJHRoaXMtPmRlYnVmZmVyKSA9PSAxNikgew0KJHRoaXMtPmRlY3J5cHRJViA9ICR0aGlzLT5kZWJ1ZmZlcjsNCiR0aGlzLT5kZWJ1ZmZlciA9ICcnOw0KbWNyeXB0X2dlbmVyaWNfaW5pdCgkdGhpcy0+ZGVtY3J5cHQsICR0aGlzLT5rZXksICR0aGlzLT5kZWNyeXB0SVYpOw0KfQ0KJGNpcGhlcnRleHQgPSBzdWJzdHIoJGNpcGhlcnRleHQsIHN0cmxlbigkcGxhaW50ZXh0KSk7DQp9IGVsc2Ugew0KJHBsYWludGV4dCA9ICcnOw0KfQ0KDQokbGFzdF9wb3MgPSBzdHJsZW4oJGNpcGhlcnRleHQpICYgMHhGRkZGRkZGMDsNCiRwbGFpbnRleHQuPSAkbGFzdF9wb3MgPyBtZGVjcnlwdF9nZW5lcmljKCR0aGlzLT5kZW1jcnlwdCwgc3Vic3RyKCRjaXBoZXJ0ZXh0LCAwLCAkbGFzdF9wb3MpKSA6ICcnOw0KDQppZiAoc3RybGVuKCRjaXBoZXJ0ZXh0KSAmIDB4Rikgew0KaWYgKHN0cmxlbigkcGxhaW50ZXh0KSkgew0KJHRoaXMtPmRlY3J5cHRJViA9IHN1YnN0cigkY2lwaGVydGV4dCwgJGxhc3RfcG9zIC0gMTYsIDE2KTsNCn0NCiR0aGlzLT5kZWNyeXB0SVYgPSBtY3J5cHRfZ2VuZXJpYygkdGhpcy0+ZWNiLCAkdGhpcy0+ZGVjcnlwdElWKTsNCiR0aGlzLT5kZWJ1ZmZlciA9IHN1YnN0cigkY2lwaGVydGV4dCwgJGxhc3RfcG9zKTsNCiRwbGFpbnRleHQuPSAkdGhpcy0+ZGVidWZmZXIgXiAkdGhpcy0+ZGVjcnlwdElWOw0KfQ0KDQpyZXR1cm4gJHBsYWludGV4dDsNCn0NCg0KaWYgKCR0aGlzLT5wYWRkYWJsZSkgew0KJGNpcGhlcnRleHQgPSBzdHJfcGFkKCRjaXBoZXJ0ZXh0LCAoc3RybGVuKCRjaXBoZXJ0ZXh0KSArIDE1KSAmIDB4RkZGRkZGRjAsIGNocigwKSk7DQp9DQoNCiRwbGFpbnRleHQgPSBtZGVjcnlwdF9nZW5lcmljKCR0aGlzLT5kZW1jcnlwdCwgJGNpcGhlcnRleHQpOw0KDQppZiAoISR0aGlzLT5jb250aW51b3VzQnVmZmVyKSB7DQptY3J5cHRfZ2VuZXJpY19pbml0KCR0aGlzLT5kZW1jcnlwdCwgJHRoaXMtPmtleSwgJHRoaXMtPml2KTsNCn0NCg0KcmV0dXJuICR0aGlzLT5wYWRkYWJsZSA/ICR0aGlzLT5fdW5wYWQoJHBsYWludGV4dCkgOiAkcGxhaW50ZXh0Ow0KfQ0KDQpyZXR1cm4gcGFyZW50OjpkZWNyeXB0KCRjaXBoZXJ0ZXh0KTsNCn0NCmZ1bmN0aW9uIF9tY3J5cHRTZXR1cCgpDQp7DQppZiAoISR0aGlzLT5jaGFuZ2VkKSB7DQpyZXR1cm47DQp9DQoNCmlmICghJHRoaXMtPmV4cGxpY2l0X2tleV9sZW5ndGgpIHsNCiRsZW5ndGggPSBzdHJsZW4oJHRoaXMtPmtleSkgPj4gMjsNCmlmICgkbGVuZ3RoID4gOCkgew0KJGxlbmd0aCA9IDg7DQp9IGVsc2UgaWYgKCRsZW5ndGggPCA0KSB7DQokbGVuZ3RoID0gNDsNCn0NCiR0aGlzLT5OayA9ICRsZW5ndGg7DQokdGhpcy0+a2V5X3NpemUgPSAkbGVuZ3RoIDw8IDI7DQp9DQoNCnN3aXRjaCAoJHRoaXMtPk5rKSB7DQpjYXNlIDQ6DQokdGhpcy0+a2V5X3NpemUgPSAxNjsNCmJyZWFrOw0KY2FzZSA1Og0KY2FzZSA2Og0KJHRoaXMtPmtleV9zaXplID0gMjQ7DQpicmVhazsNCmNhc2UgNzoNCmNhc2UgODoNCiR0aGlzLT5rZXlfc2l6ZSA9IDMyOw0KfQ0KDQokdGhpcy0+a2V5ID0gc3RyX3BhZChzdWJzdHIoJHRoaXMtPmtleSwgMCwgJHRoaXMtPmtleV9zaXplKSwgJHRoaXMtPmtleV9zaXplLCBjaHIoMCkpOw0KJHRoaXMtPmVuY3J5cHRJViA9ICR0aGlzLT5kZWNyeXB0SVYgPSAkdGhpcy0+aXYgPSBzdHJfcGFkKHN1YnN0cigkdGhpcy0+aXYsIDAsIDE2KSwgMTYsIGNocigwKSk7DQoNCmlmICghaXNzZXQoJHRoaXMtPmVubWNyeXB0KSkgew0KJG1vZGUgPSAkdGhpcy0+bW9kZTsNCg0KJHRoaXMtPmRlbWNyeXB0ID0gbWNyeXB0X21vZHVsZV9vcGVuKE1DUllQVF9SSUpOREFFTF8xMjgsICcnLCAkbW9kZSwgJycpOw0KJHRoaXMtPmVubWNyeXB0ID0gbWNyeXB0X21vZHVsZV9vcGVuKE1DUllQVF9SSUpOREFFTF8xMjgsICcnLCAkbW9kZSwgJycpOw0KfQ0KDQptY3J5cHRfZ2VuZXJpY19pbml0KCR0aGlzLT5kZW1jcnlwdCwgJHRoaXMtPmtleSwgJHRoaXMtPml2KTsNCm1jcnlwdF9nZW5lcmljX2luaXQoJHRoaXMtPmVubWNyeXB0LCAkdGhpcy0+a2V5LCAkdGhpcy0+aXYpOw0KDQokdGhpcy0+Y2hhbmdlZCA9IGZhbHNlOw0KfQ0KZnVuY3Rpb24gX2VuY3J5cHRCbG9jaygkaW4pDQp7DQokc3RhdGUgPSB1bnBhY2soJ04qd29yZCcsICRpbik7DQoNCiROciA9ICR0aGlzLT5OcjsNCiR3ID0gJHRoaXMtPnc7DQokdDAgPSAkdGhpcy0+dDA7DQokdDEgPSAkdGhpcy0+dDE7DQokdDIgPSAkdGhpcy0+dDI7DQokdDMgPSAkdGhpcy0+dDM7DQoNCiRzdGF0ZSA9IGFycmF5KA0KJHN0YXRlWyd3b3JkMSddIF4gJHdbMF1bMF0sDQokc3RhdGVbJ3dvcmQyJ10gXiAkd1swXVsxXSwNCiRzdGF0ZVsnd29yZDMnXSBeICR3WzBdWzJdLA0KJHN0YXRlWyd3b3JkNCddIF4gJHdbMF1bM10NCik7DQpmb3IgKCRyb3VuZCA9IDE7ICRyb3VuZCA8ICR0aGlzLT5OcjsgJHJvdW5kKyspIHsNCiRzdGF0ZSA9IGFycmF5KA0KJHQwWyRzdGF0ZVswXSAmIDB4RkYwMDAwMDBdIF4gJHQxWyRzdGF0ZVsxXSAmIDB4MDBGRjAwMDBdIF4gJHQyWyRzdGF0ZVsyXSAmIDB4MDAwMEZGMDBdIF4gJHQzWyRzdGF0ZVszXSAmIDB4MDAwMDAwRkZdIF4gJHdbJHJvdW5kXVswXSwNCiR0MFskc3RhdGVbMV0gJiAweEZGMDAwMDAwXSBeICR0MVskc3RhdGVbMl0gJiAweDAwRkYwMDAwXSBeICR0Mlskc3RhdGVbM10gJiAweDAwMDBGRjAwXSBeICR0M1skc3RhdGVbMF0gJiAweDAwMDAwMEZGXSBeICR3WyRyb3VuZF1bMV0sDQokdDBbJHN0YXRlWzJdICYgMHhGRjAwMDAwMF0gXiAkdDFbJHN0YXRlWzNdICYgMHgwMEZGMDAwMF0gXiAkdDJbJHN0YXRlWzBdICYgMHgwMDAwRkYwMF0gXiAkdDNbJHN0YXRlWzFdICYgMHgwMDAwMDBGRl0gXiAkd1skcm91bmRdWzJdLA0KJHQwWyRzdGF0ZVszXSAmIDB4RkYwMDAwMDBdIF4gJHQxWyRzdGF0ZVswXSAmIDB4MDBGRjAwMDBdIF4gJHQyWyRzdGF0ZVsxXSAmIDB4MDAwMEZGMDBdIF4gJHQzWyRzdGF0ZVsyXSAmIDB4MDAwMDAwRkZdIF4gJHdbJHJvdW5kXVszXQ0KKTsNCg0KfQ0KJHN0YXRlID0gYXJyYXkoDQokdGhpcy0+X3N1YldvcmQoJHN0YXRlWzBdKSwNCiR0aGlzLT5fc3ViV29yZCgkc3RhdGVbMV0pLA0KJHRoaXMtPl9zdWJXb3JkKCRzdGF0ZVsyXSksDQokdGhpcy0+X3N1YldvcmQoJHN0YXRlWzNdKQ0KKTsNCg0KJHN0YXRlID0gYXJyYXkoDQooJHN0YXRlWzBdICYgMHhGRjAwMDAwMCkgXiAoJHN0YXRlWzFdICYgMHgwMEZGMDAwMCkgXiAoJHN0YXRlWzJdICYgMHgwMDAwRkYwMCkgXiAoJHN0YXRlWzNdICYgMHgwMDAwMDBGRikgXiAkdGhpcy0+d1skdGhpcy0+TnJdWzBdLA0KKCRzdGF0ZVsxXSAmIDB4RkYwMDAwMDApIF4gKCRzdGF0ZVsyXSAmIDB4MDBGRjAwMDApIF4gKCRzdGF0ZVszXSAmIDB4MDAwMEZGMDApIF4gKCRzdGF0ZVswXSAmIDB4MDAwMDAwRkYpIF4gJHRoaXMtPndbJHRoaXMtPk5yXVsxXSwNCigkc3RhdGVbMl0gJiAweEZGMDAwMDAwKSBeICgkc3RhdGVbM10gJiAweDAwRkYwMDAwKSBeICgkc3RhdGVbMF0gJiAweDAwMDBGRjAwKSBeICgkc3RhdGVbMV0gJiAweDAwMDAwMEZGKSBeICR0aGlzLT53WyR0aGlzLT5Ocl1bMl0sDQooJHN0YXRlWzNdICYgMHhGRjAwMDAwMCkgXiAoJHN0YXRlWzBdICYgMHgwMEZGMDAwMCkgXiAoJHN0YXRlWzFdICYgMHgwMDAwRkYwMCkgXiAoJHN0YXRlWzJdICYgMHgwMDAwMDBGRikgXiAkdGhpcy0+d1skdGhpcy0+TnJdWzNdDQopOw0KDQpyZXR1cm4gcGFjaygnTionLCAkc3RhdGVbMF0sICRzdGF0ZVsxXSwgJHN0YXRlWzJdLCAkc3RhdGVbM10pOw0KfQ0KDQpmdW5jdGlvbiBfZGVjcnlwdEJsb2NrKCRpbikNCnsNCiRzdGF0ZSA9IHVucGFjaygnTip3b3JkJywgJGluKTsNCg0KJE5yID0gJHRoaXMtPk5yOw0KJGR3ID0gJHRoaXMtPmR3Ow0KJGR0MCA9ICR0aGlzLT5kdDA7DQokZHQxID0gJHRoaXMtPmR0MTsNCiRkdDIgPSAkdGhpcy0+ZHQyOw0KJGR0MyA9ICR0aGlzLT5kdDM7DQoNCiRzdGF0ZSA9IGFycmF5KA0KJHN0YXRlWyd3b3JkMSddIF4gJGR3WyR0aGlzLT5Ocl1bMF0sDQokc3RhdGVbJ3dvcmQyJ10gXiAkZHdbJHRoaXMtPk5yXVsxXSwNCiRzdGF0ZVsnd29yZDMnXSBeICRkd1skdGhpcy0+TnJdWzJdLA0KJHN0YXRlWyd3b3JkNCddIF4gJGR3WyR0aGlzLT5Ocl1bM10NCik7DQoNCmZvciAoJHJvdW5kID0gJHRoaXMtPk5yIC0gMTsgJHJvdW5kID4gMDsgJHJvdW5kLS0pIHsNCiRzdGF0ZSA9IGFycmF5KA0KJGR0MFskc3RhdGVbMF0gJiAweEZGMDAwMDAwXSBeICRkdDFbJHN0YXRlWzNdICYgMHgwMEZGMDAwMF0gXiAkZHQyWyRzdGF0ZVsyXSAmIDB4MDAwMEZGMDBdIF4gJGR0M1skc3RhdGVbMV0gJiAweDAwMDAwMEZGXSBeICRkd1skcm91bmRdWzBdLA0KJGR0MFskc3RhdGVbMV0gJiAweEZGMDAwMDAwXSBeICRkdDFbJHN0YXRlWzBdICYgMHgwMEZGMDAwMF0gXiAkZHQyWyRzdGF0ZVszXSAmIDB4MDAwMEZGMDBdIF4gJGR0M1skc3RhdGVbMl0gJiAweDAwMDAwMEZGXSBeICRkd1skcm91bmRdWzFdLA0KJGR0MFskc3RhdGVbMl0gJiAweEZGMDAwMDAwXSBeICRkdDFbJHN0YXRlWzFdICYgMHgwMEZGMDAwMF0gXiAkZHQyWyRzdGF0ZVswXSAmIDB4MDAwMEZGMDBdIF4gJGR0M1skc3RhdGVbM10gJiAweDAwMDAwMEZGXSBeICRkd1skcm91bmRdWzJdLA0KJGR0MFskc3RhdGVbM10gJiAweEZGMDAwMDAwXSBeICRkdDFbJHN0YXRlWzJdICYgMHgwMEZGMDAwMF0gXiAkZHQyWyRzdGF0ZVsxXSAmIDB4MDAwMEZGMDBdIF4gJGR0M1skc3RhdGVbMF0gJiAweDAwMDAwMEZGXSBeICRkd1skcm91bmRdWzNdDQopOw0KfQ0KDQokc3RhdGUgPSBhcnJheSgNCiR0aGlzLT5faW52U3ViV29yZCgoJHN0YXRlWzBdICYgMHhGRjAwMDAwMCkgXiAoJHN0YXRlWzNdICYgMHgwMEZGMDAwMCkgXiAoJHN0YXRlWzJdICYgMHgwMDAwRkYwMCkgXiAoJHN0YXRlWzFdICYgMHgwMDAwMDBGRikpIF4gJGR3WzBdWzBdLA0KJHRoaXMtPl9pbnZTdWJXb3JkKCgkc3RhdGVbMV0gJiAweEZGMDAwMDAwKSBeICgkc3RhdGVbMF0gJiAweDAwRkYwMDAwKSBeICgkc3RhdGVbM10gJiAweDAwMDBGRjAwKSBeICgkc3RhdGVbMl0gJiAweDAwMDAwMEZGKSkgXiAkZHdbMF1bMV0sDQokdGhpcy0+X2ludlN1YldvcmQoKCRzdGF0ZVsyXSAmIDB4RkYwMDAwMDApIF4gKCRzdGF0ZVsxXSAmIDB4MDBGRjAwMDApIF4gKCRzdGF0ZVswXSAmIDB4MDAwMEZGMDApIF4gKCRzdGF0ZVszXSAmIDB4MDAwMDAwRkYpKSBeICRkd1swXVsyXSwNCiR0aGlzLT5faW52U3ViV29yZCgoJHN0YXRlWzNdICYgMHhGRjAwMDAwMCkgXiAoJHN0YXRlWzJdICYgMHgwMEZGMDAwMCkgXiAoJHN0YXRlWzFdICYgMHgwMDAwRkYwMCkgXiAoJHN0YXRlWzBdICYgMHgwMDAwMDBGRikpIF4gJGR3WzBdWzNdDQopOw0KDQpyZXR1cm4gcGFjaygnTionLCAkc3RhdGVbMF0sICRzdGF0ZVsxXSwgJHN0YXRlWzJdLCAkc3RhdGVbM10pOw0KfQ0KfQ0K"));
$fileself = $_SERVER['PHP_SELF'];

function table1($str) {
	echo "
	<center>
	<table border=10 cellpadding=5>
	<tr height=50%>
		<td colspan=2><h1><center>Welcome to the Sky Fortress<br /><small>$str</small></center></h1></td>
	</tr>	 
	<tr height=50%>
		<td width=100%>
	";
}

function table2() {
	echo "</td>
	</tr>
	</table>
	</center>";
}
?>

<html>
<head>
<title>Sky Fortress</title>
<style>
body {
	background: #222;
}

table {
	width: 80%;
	height: 100%;
	background: #999;
}
</style>
</head>
<body>

<?php
if(isset($_FILES['file'])) {
	table1("File upload pt. 2");
	$deletionkey = md5(rand(0,0x7FFFFF));
	$rand = hash("crc32", $deletionkey) . ".txt";
	if($_FILES['file']['size'] > 10485760) { 
		echo "File too large. Uploaded files can be no more than 10MB.";
	} else {
		if(move_uploaded_file($_FILES['file']['tmp_name'], "crypt/$rand")) {
			$contents = file_get_contents("crypt/$rand");
			$crypt = new CRYPT_AES(CRYPT_AES_MODE_ECB);
			$crypt->setKey($_POST['password']);
			$contents = $crypt->encrypt($contents);

			$f = fopen("crypt/$rand", "w");
			fwrite($f, $contents);
			fclose($f);

			echo "The file " . $_FILES['file']['name'] . " has been uploaded as crypt/$rand. <br />
			To download your file in its encrypted form, <a href='crypt/$rand'>click here</a>.<br />
			To decrypt your file for a usable download, <a href='$fileself?mode=decrypt&file=$rand'>click here</a>.<br />
			To delete your file, <a href='$fileself?mode=delete&file=$rand&key=$deletionkey'>click here</a>.<br />
			";
		} else {
			echo "There was an error uploading the file, please try again.";
		}
	}
	table2()
	}
elseif($_GET['mode'] == "delete") {
	table1("File deletion");

	if(hash("crc32", $_GET['key']) == substr($_GET['file'], 0, -4) && file_exists("crypt/" . $_GET['file'])) {
		if(unlink("crypt/" . $_GET['file'])) {
			echo "File deleted successfully.";
		} else {
			echo "Error deleting file.";
		}
	} else {
		echo "Error deleting file. (Invalid deletion key or file name.)";
	}

	table2()
} elseif($_GET['mode'] == "encrypt") {
	echo "<center>
	<table border=10 cellpadding=5>
	<tr height=50%>
		<td colspan=2><h1><center>Welcome to the Sky Fortress<br /><small>File upload</small></center></h1></td>
	</tr>	 
	<tr height=50%>
		<td width=50%>
			File size limit is 10MB.<br />
			We cannot help you recover a file's password if you lose it.<br />
			There are no requirements on password length. 
		</td>
		<td width=50%>
			<form enctype='multipart/form-data' action='$fileself' method='post'>
			<input type='password' name='password' style='width: 50%' placeholder='Password'/><br />
			<input name='file' type='file' /><br />
			<input type='submit' value='Upload File' />
			</form>
		</td>
	</tr>
	</table>
	</center>";
} elseif($_GET['mode'] == "decrypt") {
	table1("File decryption");

	if(!isset($_GET['file'])) {
		echo "<center><h2>No file selected</h2>
		<small>(Maybe you should <a href='$fileself?mode=browse'>look for it</a>?)</small>
		<form action='$fileself?mode=decrypt' method='get'><br />
		<input type='text' placeholder='File name' name='file'><br />
		<input type='submit' value='Decrypt'><br />
		</form></center>";
	} else {
		if(file_exists("crypt/" . $_GET['file'])) {
			if(!isset($_POST['password'])) {
				echo "<center><h2>Decrypting " . htmlentities($_GET['file']) . "</h2>
				<form action='$fileself?file=".$_GET['file']."&mode=decrypt' method='post'><br />
				<input type='password' name='password' placeholder='Password'><br />
				<input type='submit' value='Decrypt'><br />
				</form></center>";
			} else {
				$crypt = new CRYPT_AES(CRYPT_AES_MODE_ECB);
				$crypt->setKey($_POST['password']);
				$decrypted = $crypt->decrypt(file_get_contents("crypt/" . $_GET['file']));
				if($decrypted == null || $decrypted == "") {
					echo "Incorrect password.";
				} else {
					$deletionkey = md5(rand(0,0x7FFFFF));
					$rand = hash("crc32", $deletionkey);
					$rand = $rand . ".txt";

					$f = fopen("crypt/" . $rand, "w+");
					fwrite($f, $decrypted);
					fclose($f);

					echo "File successfully decrypted. Download it <a href='crypt/$rand'>here</a>.<br /><br />
					<strong><em>VERY IMPORTANT!</em></strong><br />
					Though your decrypted file may blend in with the other files in the crypt folder, it is decrypted and anybody who stumbles upon it and realizes it isn't encrypted can download it. We will do our best to delete any decrypted files we find but the fact of the matter is we simply won't find all of them because they do blend in.<br />
					As such, it is your responsibility to use <a href='$fileself?mode=delete&key=$deletionkey&file=$rand'>this link</a> to delete the decrypted file once you've downloaded it.";
				}
			}
		}
	}
	table2()
} elseif($_GET['mode'] == "browse") {
	echo "
	<center>
	<table border=10 cellpadding=5>
	<tr height=50%>
		<td colspan=2><h1><center>Welcome to the Sky Fortress<br /><small>File browser</small></center></h1></td>
	</tr>	 
	<tr height=50%>
		<td width=100%><pre>
";

	foreach(scandir("crypt") as $cryptofile) {
		if($cryptofile != "." && $cryptofile != "..") {
			$size = round(filesize("crypt/" . $cryptofile)/1024, 2, PHP_ROUND_HALF_UP);
			$lastmod = date("F d Y H:i:s.", filemtime($filename));
			echo "<a href='$fileself?mode=decrypt&file=$cryptofile'>$cryptofile</a> - $size KB - Last modified $lastmod\n";
		}
	}

	echo "</pre></td>
	</tr>
	</table>
	</center>";
} elseif($_GET['mode'] == "quine") {
	echo "
	<center>
	<table border=10 cellpadding=5 width=80%> 
	<tr height=100%>
		<td width=100%><pre>
";
	echo htmlentities(file_get_contents(substr($_SERVER['PHP_SELF'], 1)));
	//echo $self;

	echo "</pre></td>
	</tr>
	</table>
	</center>";
}
else {
	echo "
<center>
<table border=10 cellpadding=5>
<tr height=50%>
	<td colspan=3><h1><center>Welcome to the Sky Fortress<br /><small>Home</small></center></h1></td>
</tr>	 
<tr height=50%>
	<td width=33%>
		<center><h2>About</h2></center><br />
		Sky Fortress is an <a href='$fileself?mode=quine'>open source</a> standalone PHP file for encrypted file upload and download. All files are stored encrypted without human-readable names or extensions so that nobody knows what the files are except the people who uploaded them.
	</td>
	<td width=34%>
		<center><h2>Actions</h2></center><br />
		<ul>
			<li><a href='$fileself?mode=encrypt'>Encrypt a file</a></li>
			<li><a href='$fileself?mode=decrypt'>Decrypt a file</a></li>
			<li><a href='$fileself?mode=browse'>Browse files</a></li>
			<li><a href='$fileself?mode=quine'>View Sky Fortress source</a></li>
		</ul>
	</td>
	<td width=33%>
		<center><h2>Misc</h2></center><br />
		<strong>Version</strong>: <em>1.0</em><br />
		<strong>Developer</strong>: <em>Cher Ami</em><br />
		<strong>Contact</strong>: <em>cherami@tormail.net</em>
	</td>
</tr>
</table>
</center>";
}

?>

</body>
</html>
